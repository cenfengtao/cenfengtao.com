<?php
namespace Home\Controller;

use Think\Controller;
use Think\Exception;
use \Think\Image;

require_once __DIR__ . '/../../../ThinkPHP/Library/Org/Util/JSDDK.class.php';

class TestController extends Controller
{
    function setSessionTest()
    {
        $_SESSION['openid'] = $_GET['open_id'];
        $_SESSION['token'] = $_GET['token'];
        $this->display();
    }

    public function test()
    {
        $url = $this->getQrcodeBargainUrl("58", '1', '7904');
        $pic1 = "./Public/images/_20170508105533_01_12.jpg";
        $pic2 = $this->getwechathead("http://wx.qlogo.cn/mmopen/CuUjOcQeOKQozHXfZyPyJiaLJS1vTu09TFPfT5wwvVSybCyJJFichT6bFRVd7kh9ibpibXnTm1z70CHVic1wLu8CJsFxF2BUb0hOw/0");
        $background = imagecreatetruecolor(900, 1600); // 背景图片
        $color = imagecolorallocate($background, 255, 255, 255); // 为真彩色画布创建白色背景，再设置为透明
        imagefill($background, 0, 0, $color);
        $resource1 = imagecreatefromjpeg($pic1);
        $resource2 = imagecreatefromjpeg($pic2);
        imagecopyresized($background, $resource1, 0, 0, 0, 0, 900, 1100, imagesx($resource1), imagesy($resource1));
        imagecopyresized($background, $resource2, 20, 1250, 0, 0, 200, 200, imagesx($resource2), imagesx($resource2));
        imagettftext($background, 30, 0, 220, 1250, imagecolorallocate($background, 0, 139, 139), "Font/msyh.ttc", "叼你个嘴");
        header("Content-type: image/png");
        imagepng($background);
    }

    function ali_api_request($method, $url, $headers = array())
    {
        array_push($headers, "Authorization:APPCODE " . "bb851762499542599b8bdd7b4b8a45d6");
        $curl = curl_init();
        curl_setopt($curl, CURLOPT_CUSTOMREQUEST, $method);
        curl_setopt($curl, CURLOPT_URL, $url);
        curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);
        curl_setopt($curl, CURLOPT_FAILONERROR, false);
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($curl, CURLOPT_HEADER, false);
        if (1 == strpos("$" . $url, "https://")) {
            curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);
            curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, false);
        }
        $result = curl_exec($curl);
        return $result;
    }

    public function testEncode()
    {
        $baseStr = "";
        //匹配出图片的格式
        if (preg_match('/^(data:\s*image\/(\w+);base64,)/', $baseStr, $result)) {
            $type = $result[2];
            $new_file = "Upload/Poster/" . date('Ymd', time()) . "/";
            if (!file_exists($new_file)) {
                //检查是否有该文件夹，如果没有就创建，并给予最高权限
                $result = mkdir($new_file, 0777, true);
            }
            $new_file = $new_file . time() . ".{$type}";
            if (file_put_contents($new_file, base64_decode(str_replace($result[1], '', $baseStr)))) {
                echo '新文件保存成功：', $new_file;
            } else {
                echo '新文件保存失败';
            }
        }
    }

    public function attentioni()
    {
        $access_token = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=" . C('APPID') . "&secret=" . C('SECRET');
        $access_msg = json_decode(file_get_contents($access_token));
        $token = $access_msg->access_token;
        $subscribe_msg = "https://api.weixin.qq.com/cgi-bin/user/info?access_token=$token&openid=" . $_SESSION['openid'];
        $subscribe = json_decode(file_get_contents($subscribe_msg));
        $result = $subscribe->subscribe;
        if ($result === 1) {
            echo "已关注";
        } else {
            echo "未关注";
        }
    }
    
    function getQrcodeBargainUrl($proId, $key, $shareUserId)
    {
        $url = "https://api.weixin.qq.com/cgi-bin/qrcode/create";
        $body = array(
            'action_name' => 'QR_LIMIT_STR_SCENE',
            'action_info' => array(
                'scene' => array(
                    'scene_str' => "bargainUrl=" . "http://" . $_SERVER['HTTP_HOST'] . "/index.php/Product/bargainHelp?pro_id={$proId}&key={$key}&share_user_id={$shareUserId}",
                )
            )
        );
        $body = json_encode($body);
        //生成结果返回
        $result = post_weixin_curl(get_wxuser("g232238gc959"), $url, $body);
        return $result['url'];
    }

    function httpGet($url)
    {
        $curl = curl_init();
        curl_setopt($curl, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($curl, CURLOPT_TIMEOUT, 500);
        //下面2行代码打开ssl安全校验。
        // 如果在部署过程中代码在此处验证失败，请到 http://curl.haxx.se/ca/cacert.pem 下载新的证书判别文件。
        curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, 0);
        curl_setopt($curl, CURLOPT_URL, $url);
        $res = curl_exec($curl);
        curl_close($curl);
        return $res;
    }

    function getwechathead($url)
    {
        $new_file = "Upload/" . date('Ymd', time()) . "/";
        if (!file_exists($new_file)) {
            //检查是否有该文件夹，如果没有就创建，并给予最高权限
            mkdir($new_file, 0777, true);
        }
        $filename = $new_file . time() . '.jpg';
        $head = $this->httpGet($url);
        file_put_contents('./' . $filename, $head);
        return "./" . $filename;
    }
}
