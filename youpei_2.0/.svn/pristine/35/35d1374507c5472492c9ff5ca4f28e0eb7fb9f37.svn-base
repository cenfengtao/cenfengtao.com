<include file="Common:header"/>
<!-- NProgress -->
<link href="__PUBLIC__/vendors/nprogress/nprogress.css" rel="stylesheet">
<!-- iCheck -->
<link href="__PUBLIC__/vendors/iCheck/skins/flat/green.css" rel="stylesheet">
<link rel="stylesheet" href="__PUBLIC__/css/admin/main.css">
<link rel="stylesheet" href="__PUBLIC__/js/webuploader/webuploader.css"/>
<style>
    .webuploader-pick {
        padding: 10px 20px;
    }
</style>
<body class="nav-md">
<div class="container body">
    <div class="main_container">
        <include file="Common:menu"/>
        <!-- page content -->
        <div class="right_col" role="main">
            <div class="row">
                <div class="col-md-12 col-sm-12 col-xs-12">
                    <div class="x_panel">
                        <div class="x_title">
                            <h2> 全景列表 </h2>
                            <a href="javascript:addFullShotClass()" class="btn btn-success add_button btn_access"
                               access_id="184">添加分类</a>
                            <div class="clearfix"></div>
                        </div>
                        <div class="x_content">
                            <!-- start accordion -->
                            <div class="accordion" id="accordion" role="tablist" aria-multiselectable="true">
                                <foreach name="list" key="k" item="val">
                                    <div class="panel">
                                        <a class="panel-heading collapsed" role="tab"
                                           data-toggle="collapse" data-parent="#accordion" href="#collapse{$val['id']}"
                                           aria-expanded="false" aria-controls="collapseOne">
                                            <div class="father_edit" style="float: right;display: none;">
                                                <span onclick="editFullShotClass({$val['id']})" class="btn_access"
                                                      access_id="184">修改</span>
                                                <span class="table-button-delete btn_access" access_id="185" attr_message="确认删除该菜单？" attr_id="{$val['id']}">删除</span>&nbsp;&nbsp;&nbsp;
                                            </div>
                                            <h4 class="panel-title">{$val['class_title']}</h4>
                                        </a>
                                        <div id=collapse{$val['id']}
                                             class="panel-collapse {$k==0?'collapse in':'collapse'}" role="tabpanel">
                                            <empty name="val['child']">
                                                <else/>
                                                <div class="panel-body">
                                                    <table class="table table-bordered">
                                                        <thead>
                                                        <tr>
                                                            <th>标题</th>
                                                            <th>图片</th>
                                                            <th>排序</th>
                                                            <th>描述</th>
                                                            <th>操作</th>
                                                        </tr>
                                                        </thead>
                                                        <tbody>
                                                        <foreach name="val['child']" item="vo">
                                                            <tr>
                                                                <td>{$vo['title']}</td>
                                                                <td><img src="{$vo['image']}"
                                                                         style="width:200px;height:200px;"></td>
                                                                <td>{$vo['sort']}</td>
                                                                <td>{$vo['description']}</td>
                                                                <td>
                                                                    <a href="/admin.php/FullShot/editFullShot?id={$vo['id']}"
                                                                       class="btn_access" access_id="187">修改</a>
                                                                    <a href="javascript:void(0)"
                                                                       class="delete-shot btn_access"
                                                                       access_id="188"
                                                                       attr_message="确认删除该图片？"
                                                                       attr_id="{$vo['id']}">删除</a>
                                                                </td>
                                                            </tr>
                                                        </foreach>
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </empty>
                                        </div>
                                    </div>
                                </foreach>
                            </div>
                            <hr style="width:100%;height:2px;background:#999999">
                            <form id="demo-form2" data-parsley-validate
                                  class="form-horizontal form-label-left form-youpei">
                                <div class="form-group">
                                    <label class="control-label col-md-3 col-sm-3 col-xs-12">标题 </label>
                                    <div class="col-md-3 col-sm-6 col-xs-12">
                                        <input type="text" name="title" required="required"
                                               class="form-control col-md-7 col-xs-12">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="control-label col-md-3 col-sm-3 col-xs-12">分类</label>
                                    <div class="col-md-3 col-sm-6 col-xs-12">
                                        <select class="form-control" name="class_id" required="required">
                                            <foreach name="classList" item="val">
                                                <option value="{$val['id']}">{$val['class_title']}</option>
                                            </foreach>
                                        </select>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="control-label col-md-3 col-sm-3 col-xs-12">排序</label>
                                    <div class="col-md-3 col-sm-6 col-xs-12">
                                        <input type="number" name="sort" value="0"
                                               class="form-control col-md-7 col-xs-12">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="control-label col-md-3 col-sm-3 col-xs-12">图片</label>
                                    <div class="col-md-3 col-sm-6 col-xs-12">
                                        <div id="filePicker">上传图片</div>
                                        <input type="hidden" name="image" id="upload_image" tabindex="3"
                                               autocomplete="off">
                                        <img id='preview' src='' ref='' width='200' height='200' style='display:none'/>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="control-label col-md-3 col-sm-3 col-xs-12">简单描述</label>
                                    <div class="col-md-3 col-sm-6 col-xs-12">
                                        <input type="text" name="description" class="form-control col-md-7 col-xs-12">
                                    </div>
                                </div>
                                <div class="ln_solid"></div>
                                <div class="form-group">
                                    <div class="col-md-6 col-sm-6 col-xs-12 col-md-offset-3">
                                        <button class="btn btn-primary" type="reset">重置</button>
                                        <button type="button" id="table-button-submit" class="btn btn-success">提交
                                        </button>
                                    </div>
                                </div>
                            </form>
                            <!-- end of accordion -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- /page content -->
        <!-- footer content -->
        <include file="Common:footer"/>
        <!-- /footer content -->
    </div>
</div>
<!-- bootstrap-progressbar -->
<script src="__PUBLIC__/vendors/bootstrap-progressbar/bootstrap-progressbar.min.js"></script>
<!-- iCheck -->
<script src="__PUBLIC__/vendors/iCheck/icheck.min.js"></script>
<!-- FastClick -->
<script src="__PUBLIC__/vendors/fastclick/lib/fastclick.js"></script>
<script src="__PUBLIC__/js/common.js"></script>
<script src="__PUBLIC__/js/plugins/plugins.js"></script>
<script src="__PUBLIC__/js/upload.js"></script>
<script src="__PUBLIC__/js/webuploader/webuploader.js"></script>
<script>
    var SCOPE = {
        "delete_url" : "/admin.php/FullShot/deleteClass",
        'jump_url': '/admin.php/FullShot/addFullShot',
        'success_url': '/admin.php/FullShot/getList'
    };
    function addFullShotClass() {
        layer.open({
            type: 1,
            title: '添加分类',
            skin: 'layui-layer-rim',
            area: ['370px', '240px'], //宽高
            content: "<form style='margin-top:20px;' id='demo-form2' data-parsley-validate class='form-horizontal form-label-left form-youpei'>" +
            "<div class='form-group'>" +
            "<label class='control-label col-md-3 col-sm-3 col-xs-12'> 分类名称 </label>" +
            "<div class='col-md-6 col-sm-6 col-xs-12'>" +
            "<input type='text' name='class_title' value='' class='form-control col-md-7 col-xs-12'>" +
            "</div></div>" +
            "<div class='form-group'>" +
            "<label class='control-label col-md-3 col-sm-3 col-xs-12'> 排序 </label>" +
            "<div class='col-md-6 col-sm-6 col-xs-12'>" +
            "<input type='number' name='class_sort' value='0' class='form-control col-md-7 col-xs-12'>" +
            "<small>越小越靠前</small>" +
            "</div></div>" +
            "<div class='form-group'>" +
            "<div class='col-md-6 col-sm-6 col-xs-12 col-md-offset-3'>" +
            "<button class='btn btn-primary' type='reset'>重置</button>" +
            "<button type='button'  class='btn btn-success' onclick='submitAddClass()'>提交</button>" +
            "</div></div></form>"
        })
    }

    function submitAddClass(id) {
        var classTitle = $("input[name='class_title']").val();
        var classSort = $("input[name='class_sort']").val();
        if (!classTitle) {
            return dialog.error('请输入分类名称');
        }
        if(id) {
            var data = {classTitle: classTitle, sort: classSort,id:id};
        } else {
            var data = {classTitle: classTitle, sort: classSort};
        }
        var url = "/admin.php/FullShot/addFullShotClass";
        $.post(url, data, function (result) {
            if (result.status == 0) {
                return dialog.error(result.message);
            }
            if (result.status == 1) {
                return dialog.success(result.message, "/admin.php/FullShot/getList");
            }
        }, 'json');
    }

    function editFullShotClass(classId) {
        var url = '/admin.php/FullShot/getClass';
        $.get(url,{id:classId},function (result) {
            if(result.status == 0) {
                return dialog.error(result.message);
            }
            if (result.status == 1){
                layer.open({
                    type: 1,
                    title: '添加分类',
                    skin: 'layui-layer-rim',
                    area: ['370px', '240px'], //宽高
                    content: "<form style='margin-top:20px;' id='demo-form2' data-parsley-validate class='form-horizontal form-label-left form-youpei'>" +
                    "<div class='form-group'>" +
                    "<label class='control-label col-md-3 col-sm-3 col-xs-12'> 分类名称 </label>" +
                    "<div class='col-md-6 col-sm-6 col-xs-12'>" +
                    "<input type='text' name='class_title' value='"+result.data.class_title+"' class='form-control col-md-7 col-xs-12'>" +
                    "</div></div>" +
                    "<div class='form-group'>" +
                    "<label class='control-label col-md-3 col-sm-3 col-xs-12'> 排序 </label>" +
                    "<div class='col-md-6 col-sm-6 col-xs-12'>" +
                    "<input type='number' name='class_sort' value='"+result.data.sort+"' class='form-control col-md-7 col-xs-12'>" +
                    "<small>越小越靠前</small>" +
                    "</div></div>" +
                    "<div class='form-group'>" +
                    "<div class='col-md-6 col-sm-6 col-xs-12 col-md-offset-3'>" +
                    "<button class='btn btn-primary' type='reset'>重置</button>" +
                    "<button type='button'  class='btn btn-success' onclick='submitAddClass("+ classId +")'>提交</button>" +
                    "</div></div></form>"
                })
            }
        },'json');
    }

    $('.panel-heading').each(function () {
        $(this).mouseover(function () {
            $(this).find('.father_edit').show();
        });
        $(this).mouseout(function () {
            $(this).find('.father_edit').hide();
        });
    });

    var ThinkPHP = window.Think = {
        "ROOT": "__ROOT__",
        "PUBLIC": "__PUBLIC__",
        "DOMAIN": "{:HTTPDomain()}"
    };

    $(function () {
        var uploading = null;
        uploadFile({
            server: "{:U('Article/uploadPic')}",
            pick: '#filePicker',
            formData: {dir: 'adspic'},
            callback: function (result) {
                if (result.status == 1) {
                    layer.close(uploading);
                    var json = WST.toJson(result);
                    $('#preview').attr('src', ThinkPHP.DOMAIN + "/" + json.file.savepath + json.file.savethumbname);
                    $('#upload_image').val('/' + json.file.savepath + json.file.savename);
                    $('#preview').show();
                } else {
                    dialog.error(result.message);
                }
            },
            progress: function (rate) {
                uploading = WST.msg('正在上传图片，请稍后...');
            }
        });
    });

    $('.delete-shot').click(function () {
        var id = $(this).attr('attr_id');
        var message = $(this).attr('attr_message');
        var url = '/admin.php/FullShot/deleteShot';
        layer.open({
            type: 0,
            title: '确认信息',
            btn: ['确认', '取消'],
            icon: 3,
            closeBtn: 2,
            content: message,
            yes: function () {
                $.post(url, {id:id}, function (result) {
                    if (result.status == 1) {
                        return dialog.success(result.message, '');
                    } else {
                        return dialog.error(result.message);
                    }
                }, 'JSON');
            }
        });
    });
</script>
</body>
</html>