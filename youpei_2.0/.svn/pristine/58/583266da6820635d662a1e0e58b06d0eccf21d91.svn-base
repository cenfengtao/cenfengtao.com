<?php
namespace Home\Controller;

use Think\Controller;
require_once __DIR__ . '/../../../ThinkPHP/Library/Org/Util/JSDDK.class.php';
class ParentingController extends BaseController
{
    public function index(){
        $this->title="亲子列表";
        $cateId = $_GET['cate_id'] ? $_GET['cate_id'] : 0;
        if($cateId == 0){
            $list = D('Parenting')->getUpList(10,array('status' => 1,'check_status'=> 2));
        }else{
            $list = D('Parenting')->getUpListById(10,array('status' => 1,'cate_id' => $cateId,'check_status'=> 2));
        }
            foreach ($list as $k=> $v){
                $list[$k]['org_name'] = D('Organization')->getOrgNameById($v['cate_id']);
                $tags = explode(' ', $v['tag']);
                $list[$k]['tagA'] = $tags[0] ?: '';
                $list[$k]['tagB'] = $tags[1] ?: '';
                $list[$k]['tagC'] = $tags[2] ?: '';
                $list[$k]['cate_title'] = D('ParentingCate')->getTitleById($v['cate_id']);
                $list[$k]['time'] = date('Y-m-d',$v['create_time']);
                $list[$k]['logo'] = D('Organization')->getImageById($v['org_id']);
                $list[$k]['add'] = D('Organization')->getAddById($v['org_id']);
                $list[$k]['city'] = D('Organization')->getCityById($v['org_id']);
                $list[$k]['area'] = D('Organization')->getAreaById($v['org_id']);
            }

        $Homep = D('ParentingCate')->getParentingCate();
        $this->assign('list',$list)->assign('Homep',$Homep)->assign('cateId',$cateId);
        $this->display();
    }
    public function productDetails()
    {
        if ($_POST) {
            if (!$_POST['par_id'] || empty($_POST['par_id'])) {
                return show(0, '活动参数错误');
            }
            if (!$_POST['content'] || empty($_POST['content'])) {
                return show(0, '咨询内容不能为空');
            }
            $insertData = array(
                'parenting_id' => $_POST['par_id'],
                'user_id' => $this->user['id'],
                'create_time' => time(),
                'type' => 1,
                'status' => 1,
                'token' => $this->token,
                'content' => $_POST['content']
            );
            $id = D('ProductComment')->insert($insertData);
            $list = D('ProductComment')->find($id);
            $headImg = M('user')->where("id={$list['user_id']}")->field('headimgurl')->find();
            $list['headImg'] = $headImg['headimgurl'];
            if (!$list || empty($list)) {
                $this->ajaxReturn(array('status' => 0, 'msg' => '咨询失败'));
            } else {
                $this->ajaxReturn(array('status' => 1, 'msg' => '咨询成功', 'data' => $list));
            }
        } else {
            $this->title = "活动名称";
            if (!$_GET['par_id'] || !is_numeric($_GET['par_id'])) {
                $this->error('获取不到该商品信息');
            }
            try {
                $product = D('Parenting')->find($_GET['par_id']);
                $productComment = D('ProductComment')->getCommentByFatherParId(0, 0, $_GET['par_id']);
                foreach ($productComment as $k => $v) {
                    $productComment[$k]['child'] = M('ProductComment')->where(array('type_id' => $v['id'], 'parenting_id' => $v['parenting_id'],'status'=>1))->select();
                    $productComment[$k]['headImg'] = D('user')->getHeadById($v['user_id']);
                    foreach ($productComment[$k]['child'] as $ke => $va){
                        //回复
                        if($va['is_gm'] == 2){
                            //待机构管理员完善之后需修改
                            //客服头像
                            $picture = M('organization')->field('picture')->where(array('token'=>$this->token))->find();
                            $productComment[$k]['child'][$ke]['headImg'] = $picture['picture'];
                        }elseif ($va['is_gm'] == 1){
                            $productComment[$k]['child'][$ke]['headImg'] = D('user')->getHeadById($va['user_id']);
                        }
                        //被回复
                        $userId = M('ProductComment')->where(array('id'=>$productComment[$k]['child'][$ke]['father_id']))->find();
                        if($userId['is_gm'] == 2){
                            $pictures = M('organization')->field('picture')->where(array('token'=>$userId['token']))->find();
                            $productComment[$k]['child'][$ke]['headImgs'] = $pictures['picture'];
                        }else if($userId['is_gm'] == 1){
                            $productComment[$k]['child'][$ke]['headImgs'] = D('user')->getHeadById($userId['user_id']);
                        }
                    }
                }
                //标签
                $tags = explode(' ', $product['tag']);
                //机构
                $organization = D('Organization')->find($product['org_id']);
                $this->assign('product', $product)->assign('productComment', $productComment)->assign('tags', $tags)
                    ->assign('organization', $organization);
                //获取ticket
                $wxuser = get_wxuser($this->token);
                $jssdk = new \JSSDK($wxuser['appid'], $wxuser['appsecret']);
                $signPackage = $jssdk->GetSignPackage();
                //分享内容图片和链接地址
                $shareImg = 'http://' . $_SERVER["HTTP_HOST"] . $product['image'];
                $shareUrl = 'http://' . $_SERVER["HTTP_HOST"] . U('Parenting/productDetails', array('share_user_id' =>
                        $this->user['id'], 'par_id' => $_GET['par_id'], 'token' => $this->token));
                //购买商品的所有用户头像
                $productId = $_GET['par_id'];
                $userId = D('Order')->getGroupByParId($productId);
                foreach ($userId as $k => $v) {
                    $headImg[$k]['headImg'] = D('User')->getHeadById($v['user_id']);
                }
                $userCount = sizeof($userId);
                //是否收藏
                $isCollect = D('Collect')->isCollectById($this->user['id'], $_GET['par_id'],'4');
                $this->assign('signPackage', $signPackage)->assign('share_img', $shareImg)->assign('share_url', $shareUrl);
                $this->assign('headImg', $headImg)->assign('userCount', $userCount)->assign('isCollect', $isCollect);
                $this->display();
            } catch (Exception $e) {
                $this->error($e->getMessage());
            }
        }
    }
    public function checkOrderInfo(){
        $this->title="活动详情";
        if (!$_GET['par_id'] || !is_numeric($_GET['par_id'])) {
            $this->error('获取不到该活动信息');
        }
        try {
            $product = D('Parenting')->find($_GET['par_id']);
            $this->assign('product', $product);
            $this->display();
        } catch (Exception $e) {
            $this->error($e->getMessage());
        }
    }
    public function confirmationInfo(){
        $this->title="确认信息";
        $id = (int)I('id');
        $count = (int)I('count');
        $parenting = D('Parenting')->find($id);
        //显示可用的代金券和优惠券
        $totalPrice = $parenting['price'] * $count;
        //代金券
        $cashCoupons = D('Coupon')->getCashCoupon($this->user['id'], $parenting['org_id']);
        //优惠券
        $coupons = D('Coupon')->getCouponByUser($this->user['id'], $parenting['org_id']);
        $this->assign('count', $count)->assign('parenting', $parenting)->assign('id', $id)->assign('totalPrice', $totalPrice);
        $this->assign('cashCoupons', $cashCoupons)->assign('coupons', $coupons);
        $this->display();
    }

    //滑动加载
    public function loadingParenting()
    {
        $npage = (int)I("npage");
        $cateId = $_POST['cate_id'] ? $_POST['cate_id'] : 0;
        if ($cateId == 0) {
            $list = D('Parenting')->getListByPage($npage);
        } else {
            $list = D('Parenting')->getListByPage($npage,$cateId);
        }
        foreach ($list as $k=> $v){
            $list[$k]['org_name'] = D('Organization')->getOrgNameById($v['cate_id']);
            $tags = explode(' ', $v['tag']);
            $list[$k]['tagA'] = $tags[0] ?: '';
            $list[$k]['tagB'] = $tags[1] ?: '';
            $list[$k]['tagC'] = $tags[2] ?: '';
            $list[$k]['cate_title'] = D('ParentingCate')->getTitleById($v['cate_id']);
            $list[$k]['time'] = date('Y-m-d',$v['create_time']);
            $list[$k]['logo'] = D('Organization')->getImageById($v['org_id']);
            $list[$k]['add'] = D('Organization')->getAddById($v['org_id']);
            $list[$k]['city'] = D('Organization')->getCityById($v['org_id']);
            $list[$k]['area'] = D('Organization')->getAreaById($v['org_id']);
        }
        if (!$list || empty($list)) {
            $this->ajaxReturn(array('status' => 0, 'msg' => '没有数据'));
        }
        $this->ajaxReturn(array('status' => 1, 'msg' => '获取成功', 'data' => $list));
    }

    //分享记录
    public function shareRecord()
    {
        $insertData = [
            'create_time' => time(),
            'type' => 3,
            'type_id' => $_POST['par_id'],
            'desc' => '分享活动',
            'user_id' => $this->user['id'],
        ];
        D('ShareRecord')->insert($insertData);
        return show(0, '分享成功');
    }

    //用户之间留言对话
    public function comment()
    {
        if ($_POST) {
            if (!$_POST['parenting_id'] || empty($_POST['parenting_id'])) {
                $this->ajaxReturn(array('status' => 0, 'msg' => 'ID参数错误'));
            }
            if (!$_POST['father_id'] || empty($_POST['father_id'])) {
                $this->ajaxReturn(array('status' => 0, 'msg' => 'FATHER_ID参数错误'));
            }
            if (!$_POST['content'] || empty($_POST['content'])) {
                $this->ajaxReturn(array('status' => 0, 'msg' => '咨询内容不能为空'));
            }
            $data = [
                'user_id' => $this->user['id'],
                'father_id' => $_POST['father_id'],
                'parenting_id' => $_POST['parenting_id'],
                'content' => $_POST['content'],
                'token' => $this->token,
                'type_id' => $_POST['type_id'],
                'status' => 1,
                'type' => 1,
                'create_time' => time()
            ];
            $id = D('ProductComment')->insert($data);
            //评论人头像
            $reply = D('ProductComment')->find($id);
            $headImg = M('user')->where("id={$reply['user_id']}")->field('headimgurl')->find();
            $reply['headImg'] = $headImg['headimgurl'];
            //被评论人头像
            $replys = D('ProductComment')->find($_POST['father_id']);
            $headImgs = M('user')->where("id={$replys['user_id']}")->field('headimgurl')->find();
            $reply['headImgs'] = $headImgs['headimgurl'];
            if (!$reply || empty($reply)) {
                $this->ajaxReturn(array('status' => 0, 'msg' => '评论失败'));
            }
            $this->ajaxReturn(array('status' => 1, 'msg' => '评论成功', 'data' => $reply));
        }
    }



}




?>