<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="stylesheet" href="__PUBLIC__/vendors/upload-image/css/page-common.css">
    <link rel="stylesheet" type="text/css" href="http://www.jq22.com/jquery/font-awesome.4.6.0.css">
    <link rel="stylesheet" href="__PUBLIC__/vendors/upload-image/css/upload.css"/>
    <title></title>
    <style>
        *{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        html{
            height: 100%;
        }
        body{
            height: 100%;
            position: relative;
        }
        body .img img{
            height: 100%;
            width: 100%;
        }
        body .img{
            height: 90%;
            width: 100%;
        }

        .copy{
            position: absolute;
            top: 0;
            /*bottom:0;*/
            height: 100%;
            width: 100%;
            z-index: 10000;
            background: rgba(0,0,0,0.5);
        }
        .change{
            font-size: 16px;
            background: gray;
            color: white;
            border: none;
            width: 100%;
            height: 10%;
            line-height: 35px;
        }
        img{
            display: block;
            border:none;
        }
        .content{
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            height: 300px;
            margin: auto;
            width: 80%;
            background: white;
        }
        .copy ul{
            height: 270px;
            border-top: 1px solid gray;
        }
        .copy ul li{
            position: relative;
            /*padding-top: 20px;*/
            height: 90px;
            line-height: 90px;
            width: 100%;
            padding-left: 10px;
            border-bottom: 1px solid gray;
        }
        .copy ul li span{
            font-size: 14px;
        }
        .pic{
            position: relative;
        }
        .pic span{
            float: left;
        }
        .pic div{
            float: left;
            height: 80px;
            width: 80px;
            border: 1px solid gray;
            margin-top: 5px;
        }
        .pic div img{
            height: 80px;
            width: 80px;
            border: 1px solid gray;
        }
        #close{
            position: absolute;
            right: 30px;
            bottom: 5px;
            font-size: 14px;
            text-decoration: none;
            color: white;
            background: #57ade3;
            line-height: 30px;
            padding: 2px 5px;
            margin-left: 10px;
            border-radius: 6px;
            margin-top: 30px;
        }
        #fileChooseButton{
            position: absolute;
            right: 30px;
            top: -24px;
            font-size: 14px;
            text-decoration: none;
            color: white;
            background: #57ade3;
            line-height: 30px;
            padding: 2px 5px;
            margin-left: 10px;
            border-radius: 6px;
            margin-top: 30px;
        }
        .text{
            height: 30px;
            background: #f1f1f1;
            padding-top: 2px;
            position: relative;
        }
        .text p{
            height: 30px;
            line-height: 30px;
            font-size: 14px;
            text-align: center;
        }
        .content ul li input{
            font-size: 13px;
            height: 25px;
            padding: 5px 5px;
            width: 180px;
            resize: none;
            outline: none;
            border:none;
        }
        textarea{
        	position: absolute;
            font-size: 13px;
            top: 10px;
            padding: 5px 5px;
            resize: none;
/*            height: 90px;*/
            border: none;
            outline: none;
            overflow-y:hidden;
            widows: 70%;
            text-indent: 2em;
        }
        .text span{
            position: absolute;
            right: 10px;
            top:5px;
            font-size: 14px;
        }
        .copy{
            display: none;
        }
    </style>
</head>
<body>
    <div class="img">
        <img src="../../../../Public/images/expert_details2.jpg" alt="">
    </div>
    <input type="button" value="编辑海报" class="change">
    <div class="copy">
        <div class="content">
            <div class="text">
                <p>请编辑图片</p>
                <span>确定</span>
            </div>
            <ul>
                <li class="pic">
                    <span>图片：</span>
                    <div><img id="previewResult" alt="" /></div>
                    <a href="###" id='fileChooseButton' onclick="firstFile()">上传图片</a>
                    <input class="upload-file" type="file" id="file" accept="image/*" capture="camera" style="display: none" name="upload" />
                    <a href="###" id="close">移除图片</a>
                </li>
                <li>
                    <span>标题：</span> <input type="text" class="inputValue">
                </li>
                <li>
                    <span>内容：</span> <textarea name="" rows="4" class="textarea"></textarea>
                </li>
            </ul>
        </div>
        
        <div class="edit">
            <!-- <button id='fileChooseButton' class="button blue rarrow file-input-mask">上传图片<input class="upload-file" type="file" id="file" accept="image/*"/ multiple></button> -->
            <img id="previewResult"/>
            <img id="needCropImg" />
            <div class="app" id="uploadPage">
                <div class="upload-loading">
                <span class="centerXY"><i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i></span>
                </div>
                <div class="bar"><a class="back pull-left" id="closeCrop"><i class="fa fa-reply"></i></a><a id="getFile" class="pull-right">使用</a></div>
                <div class="main">
                    <canvas class="upload-mask">

                    </canvas>
                    <div class="preview-box">
                        <img id="preview"/>
                    </div>
                    <canvas class="photo-canvas">

                    </canvas>
                </div>
            </div>
        </div>
        
    </div>
</body>
<script src="../../../../Application/Home/View/Activity/js/jquery.min.js"></script>
<script src="__PUBLIC__/vendors/upload-image/js/require.js" ></script>
<script src="__PUBLIC__/vendors/upload-image/js/main.js"></script>
<script src="__PUBLIC__/vendors/upload-image/js/canvas-toBlob.js"></script>
<script>
function firstFile() { 
    document.getElementById("file").click(); 
    $(".content").hide();
    $("body .img img").hide();
} 
$(function(){
    $(".change").click(function(){
        $(".copy").show()
    })
    $(".text span").click(function(){
        $(".copy").hide()
        var url=$("#previewResult").attr("src")
    	var inputValue=$(".inputValue").val();
        var textarea=$(".textarea").val();
        if(url){
             $.ajax({
                url:'../Test/testUpload',
                async: true,
                type:"post",
                dataType:"json",
                data:{base64:url.substr(22),uploadType:'base64',inputValue:inputValue,textarea:textarea},//后端无需在过滤头
                success:function(data){
                    if(data.result==1){
                        console.log(data.imgPath)
                    }
                }
            })
        }
       
    })
    $("#close").click(function(){
        $("#previewResult").removeAttr("src")
    })
    $(".fa").click(function(){
        $(".copy").show()

    })
    
})

    var myCrop;
//    防require缓存
    require.config({
        urlArgs:"bust="+new Date,
        baseUrl:"__PUBLIC__/vendors/upload-image/js",
    });
    require(["jquery",'hammer','tomPlugin',"tomLib",'hammer.fake','hammer.showtouch'],function($,hammer,plugin,T){
        document.addEventListener("touchmove",function(e){
            e.preventDefault();
        });
        //初始化图片大小300*300
        var opts={cropWidth:200,cropHeight:200},
                $file=$("#file"),
                previewStyle={x:0,y:0,scale:1,rotate:0,ratio:1},
                transform= T.prefixStyle("transform"),
                $previewResult=$("#previewResult"),
                $previewBox=$(".preview-box"),
                $rotateBtn=$("#rotateBtn"),
                $getFile=$("#getFile"),
                $preview=$("#preview"),
                $uploadPage=$("#uploadPage"),
                $mask=$(".upload-mask"),
                $loading=$(".upload-loading"),
                maskCtx=$mask[0].getContext("2d"),
                $needCropImg=$("#needCropImg");

        //这是插件调用主体
        myCrop=T.cropImage({
            bindFile:$file,//绑定Input file
//            bindFile:$needCropImg[0],//绑定一个图片
            enableRatio:true,//是否启用高清,高清得到的图片会比较大
            canvas:$(".photo-canvas")[0],  //放一个canvas对象
            cropWidth:opts.cropWidth,       //剪切大小
            cropHeight:opts.cropHeight,
            bindPreview:$preview,      //绑定一个预览的img标签
            useHammer:true,            //是否使用hammer手势，否的话将不支持缩放
            oninit:function(){

            },
            onChange:function(){
                $loading.show();
                resetUserOpts();
            },
            onLoad:function(data){
                //用户每次选择图片后执行回调
                previewStyle.ratio=data.ratio;
                $preview.attr("src",data.originSrc).css({width:data.width,height:data.height}).css(transform,'scale('+1/previewStyle.ratio+')');
                myCrop.setCropStyle(previewStyle)
                $loading.hide();
            }
        });
        function resetUserOpts(){
            $(".photo-canvas").hammer('reset');
            previewStyle={scale:1,x:0,y:0,rotate:0};
            $previewResult.attr("src",'').hide();
            $preview.attr("src",'')
        }
        $('#fileChooseButton').on('click',function(){
            setTimeout(function(){
                resetUserOpts();
            })
        })
        $(".photo-canvas").hammer({
            gestureCb:function(o){
                //每次缩放拖拽的回调
                $.extend(previewStyle,o);
//                console.log("用户修改图片",previewStyle)
                $preview.css(transform,"translate3d("+ previewStyle.x+'px,'+ previewStyle.y+"px,0) rotate("+previewStyle.rotate+"deg) scale("+(previewStyle.scale/previewStyle.ratio)+")")
            }
        });
        //选择图片
        $rotateBtn.on("click",function(){
            previewStyle.rotate+=90;
            if(previewStyle.rotate>=360){
                previewStyle.rotate-=360;
            }
            $(".photo-canvas").hammer('setRotate',previewStyle.rotate)
            myCrop.setCropStyle(previewStyle)
            $preview.css(transform,"translate3d("+ previewStyle.x+'px,'+ previewStyle.y+"px,0) rotate("+previewStyle.rotate+"deg) scale("+(previewStyle.scale/previewStyle.ratio)+")")
        });
        //获取图片并关闭弹窗返回到表单界面
        $getFile.on("click",function(){
            $(".content").show()
            $("body .img img").show();
            var cropInfo;
            $uploadPage.hide();
            myCrop.setCropStyle(previewStyle)
            //自定义getCropFile({type:"png",background:"red",lowDpi:true})
            cropInfo=myCrop.getCropFile({});
            $previewResult.attr("src",cropInfo.src).show();
            var url=cropInfo.src;
            //可选传base64或者file对象
            //cropInfo.src cropInfo.dfd

            //you can upload img base64  :cheers:)
            // $.ajax({
            //     url:'../Test/testUpload',
            //     async: true,
            //     type:"post",
            //     dataType:"json",
            //     data:{base64:cropInfo.src.substr(22),uploadType:'base64'},//后端无需在过滤头
            //     success:function(data){
            //         if(data.result==1){
            //             console.log(data.imgPath)
            //         }
            //     }
            // })
            //you can upload new img file :cheers:)
            // cropInfo.dfd.done(function(blob){
            //     if(blob){
            //         var formData=new FormData;
            //         blob.name='imgFile'
            //         formData.append("imgFile",blob)
            //         formData.append("uploadType",'imgFile');
            //         $.ajax({
            //             url:'http://127.0.0.1/testAdjustImg/upload.php',
            //             type:"post",
            //             data:formData,
            //             processData:false,
            //             contentType: false,
            //             dataType:"json",
            //             success:function(data){
            //                 console.log(data)
            //                 if(data.result==1){
            //                     console.log(data.imgPath)
            //                 }
            //             }
            //         })
            //     }
            // })

        })
        //上传文件按钮&&关闭弹窗按钮
        $(document).delegate("#file","click",function(){
            $uploadPage.show();
        }).delegate("#closeCrop","click",function(){
            $uploadPage.hide();
            $(".content").show()
            $("body .img img").show();
            resetUserOpts();
            myCrop.setCropStyle(previewStyle)
        })
        $file.one("click",showCropModal)
        $previewResult.on('click',showCropModal)

        function showCropModal(){
            setTimeout(function(){
                $uploadPage.show();
                $mask.prop({width:$mask.width(),height:$mask.height()})
                maskCtx.fillStyle="rgba(0,0,0,0.7)";
                maskCtx.fillRect(0,0,$mask.width(),$mask.height());
                maskCtx.strokeStyle='white';
                maskCtx.lineWidth='2'
                maskCtx.clearRect(($mask.width()-opts.cropWidth)/2,($mask.height()-opts.cropHeight)/2,opts.cropWidth,opts.cropHeight)
                maskCtx.strokeRect(($mask.width()-opts.cropWidth)/2-1,($mask.height()-opts.cropHeight)/2-1,opts.cropWidth+2,opts.cropHeight+2);//Add a subpath with four points
            })
        }
        //单独绑定图片时用到
//        $needCropImg[0].addEventListener("load",showCropModal)
//        $needCropImg[0].src='./img/9-1.jpg';
    })
</script>
</html>