<?php
namespace Home\Controller;

use Think\Controller;
use Think\Exception;
use \Think\Image;
use Org\Util\ExcelToArray;

require_once __DIR__ . '/../../../ThinkPHP/Library/Org/Util/JSDDK.class.php';
require_once __DIR__ . '/../../../ThinkPHP/Library/Vendor/ChuanglanSmsHelper/ChuanglanSmsApi.php';

class TestController extends Controller
{
    function setSessionTest()
    {
        $_SESSION['openid'] = $_GET['open_id'];
        $_SESSION['token'] = $_GET['token'];
        $this->display();
    }

    public function test()
    {
        $article = "【优培·育儿】妈妈，我是从哪来的？";
        $start = mb_strpos($article, '】', 0, 'utf-8');
        $firstTitle = mb_substr($article, 0, $start + 1, 'utf-8');
        $secondTitle = mb_substr($article, $start + 1, null, 'utf-8');
        echo $secondTitle;
    }

    function generate_code($length = 6)
    {
        return rand(pow(10, ($length - 1)), pow(10, $length) - 1);
    }

    function deldir($dir)
    {
        //先删除目录下的文件：
        $dh = opendir($dir);
        while ($file = readdir($dh)) {
            if ($file != "." && $file != "..") {
                $fullpath = $dir . "/" . $file;
                if (!is_dir($fullpath)) {
                    unlink($fullpath);
                } else {
                    $this->deldir($fullpath);
                }
            }
        }
        closedir($dh);
        //删除当前文件夹：
        if (rmdir($dir)) {
            return true;
        } else {
            return false;
        }
    }

    public function responseExcel()
    {
        $this->success('添加成功', 'Index/index');
    }

    //创建一个读取excel数据，可用于入库
    public function _readExcel($path)
    {
        //引用PHPexcel 类
        include_once(VENDOR_PATH . 'PHPExcel/Classes/PHPExcel.php');
        include_once(VENDOR_PATH . 'PHPExcel/Classes/PHPExcel/IOFactory.php');//静态类
        $type = 'Excel2007';//设置为Excel5代表支持2003或以下版本，Excel2007代表2007版
        $xlsReader = \PHPExcel_IOFactory::createReader($type);
        $xlsReader->setReadDataOnly(true);
        $xlsReader->setLoadSheetsOnly(true);
        $Sheets = $xlsReader->load($path);
        //开始读取上传到服务器中的Excel文件，返回一个二维数组
        $dataArray = $Sheets->getSheet(0)->toArray();
        return $dataArray;
    }


    public function updateDiscovery()
    {
        _getDiscoverInfo();
    }
}
