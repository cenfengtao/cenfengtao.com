<include file="Common:header"/>
<link rel="stylesheet" href="__PUBLIC__/css/home/order.css">
<div id="page_orders_wait" title="{$title}" class="kap-page kap-page-current">
     <div class="kap-top ty-menu-top">
    <div id="tools_msg" class="ty-tools ty-tools-inner ty-tools-current">
        <span class="title">{$title}<span class="num"></span></span>
        <a href="javascript:void(0);" onclick="history.go(-1); " class="btn left btn-user" title="返回" data-icon="ɒ"></a>
        <a href="{:U('Index/index')}" class="btn right btn-user" title="返回个人中心"
           data-icon="Ņ"></a>
    </div>
</div>
    <div class="ty-page" data-ty-current="0" data-ty-total="0">
        <div class="order-list">
            <ul class="list-order">
                <volist name="list" id="val">
                    <notempty name="val['product_id']">
                        <li onclick="getProduct({$val['product_id']})">
                    </notempty>
                    <notempty name="val['parenting_id']">
                        <li onclick="getParenting({$val['parenting_id']})">
                    </notempty>
                    <notempty name="val['activity_id']">
                        <li onclick="getActivity({$val['activity_id']})">
                    </notempty>
                    <notempty name="val['group_record_id']">
                        <li onclick="getGroup({$val['group_record_id']})">
                    </notempty>
                        <div class="left"><img src="{$val['pro_pic']}" alt=""></div>
                        <div class="rig"><p class="title">{$val['pro_title']}</p><p class="desc"><span class="price"><span>￥</span>{$val['price']}</span>/人</p>
                            <p class="time">{$val['create_time'] | date="Y/m/d",###}
                                <if condition="$val['status'] eq 0">
                                    <span class="quxiao" onclick="cancelOrder({$val['id']})">取消订单</span>
                                    <span class="zhifu" onclick="payAgain({$val['id']})">重新支付</span>
                                    <elseif condition="$val['status'] eq 1" />
                                    <empty name="val['is_comment']">
                                        <span class="addComment" onclick="addComment({$val['id']})">立即评价</span>
                                        <else/>
                                        <span class="isComment">已评价</span>
                                    </empty>
                                    <empty name="val['is_appeal']">
                                        <span class="appeal" onclick="appeal({$val['id']})">申诉维权</span>
                                        <else/>
                                        <span class="appealing">申诉中</span>
                                    </empty>
                                    <elseif condition="($val['status'] eq 2) OR ($val['status'] eq 3) OR ($val['status'] eq 6) OR ($val['status'] eq 7)"/>
                                    <if condition="$val['status'] eq 2">
                                        <span class="cancel-status">已取消</span>
                                        <elseif condition="$val['status'] eq 3"/>
                                        <span class="cancel-status">支付失败</span>
                                        <elseif condition="$val['status'] eq 6"/>
                                        <span class="cancel-status">退款中</span>
                                        <elseif condition="$val['status'] eq 7"/>
                                        <span class="cancel-status">已退款</span>
                                    </if>
                                    <notempty name="val['product_id']">
                                        <span class="order-again" onclick="getProduct({$val['product_id']})">重新下单</span>
                                    </notempty>
                                    <notempty name="val['parenting_id']">
                                        <span class="order-again" onclick="getParenting({$val['parenting_id']})">重新下单</span>
                                    </notempty>
                                    <notempty name="val['activity_id']">
                                        <span class="order-again" onclick="getActivity({$val['activity_id']})">重新下单</span>
                                    </notempty>
                                    <notempty name="val['group_record_id']">
                                        <span class="order-again" onclick="getGroup({$val['group_record_id']})">重新下单</span>
                                    </notempty>
                                </if>
                            </p>
                        </div>
                    </li>
                </volist>
                <li data-icon="Ĩ" class="item-more" style="display:none;">
                    点击载入更多
                </li>
            </ul>
        </div>
    </div>
</div>
<script>
    function appeal(id) {
        window.location.href = "{:U('Orders/rejectOrder')}?orderId="+id;
    }
    function addComment(id) {
        window.location.href = "{:U('Orders/addComment')}?id="+id;
    }
    function payAgain(id) {
        var url = "{:U('Orders/payAgain')}";
        $.get(url,{id:id},function (result) {
            if(result.status == 0){
                return alert(result.message);
            } else {
                switch(result.data['pro_type']){
                    case 'product':
                        window.location.href = "{:U('WxPay/jsapiIndex')}?orderId=" + result.data['order_id'];
                        break;
                    case 'parenting':
                        //todo
                        break;
                    case 'activity' :
                        window.location.href = "{:U('WxPay/jsapiByActivity')}?orderId="+ result.data['order_id'];
                        break;
                    case 'group' :
                        window.location.href = "{:U('WxPay/jsapiByGroup')}?orderId="+ result.data['order_id'];
                        break;
                    default :
                        return alert('订单错误');
                }
            }
        },'json');
    }
    function cancelOrder(id) {
        if(confirm("确认取消该订单？")){
            var url = "{:U('Orders/cancelOrder')}";
            $.post(url, {order_id: id}, function (result) {
                if (result.status == 0) {
                    return alert(result.msg);
                } else {
                    location.reload();
                }
            }, 'json');
        }
    }
    function deleteOrder(id) {
        var url = "{:U('Orders/deleteOrder')}";
        $.post(url, {order_id: id}, function (result) {
            if (result.status == 0) {
                return alert(result.msg);
            }
            if (result.status == 1) {
                alert(result.msg);
                location.reload();
            }
        }, 'json');
    }
    function getProduct(id) {
        window.location.href = "{:U('Product/productDetails')}?pro_id="+id;
    }

    function getParenting(id) {
        window.location.href = "{:U('Parenting/productDetails')}?par_id="+id;
    }

    function getActivity(id) {
        window.location.href = "{:U('Organization/activityDetail')}?id="+id;
    }

    function getGroup(id) {
        window.location.href = "{:U('Groups/getGroup')}?id="+id;
    }
</script>
<!-- 底部菜单 -->
<div class="kap-bottom ty-menu-bottom" style="display: none">
    <div id="tools_idx" class="ty-tools ty-tools-idx ty-tools-current">
        <a href="{:U('Orders/allOrders')}" class="current" style="background: url('__PUBLIC__/images/order-icon1.png') no-repeat 0.7rem 1.2rem; background-size:20% 30%; padding-left:1rem;" data-icon="">全部</a>
        <a href="{:U('Orders/queryPayByPage')}"  style="background: url('__PUBLIC__/images/order-icon2.png') no-repeat 0.7rem 1.2rem; background-size:20% 30%; padding-left:1rem;" data-icon="" onclick="_hmt.push(['_trackEvent', 'footbar', 'click', '发现'])">待付款</a>
        <a href="{:U('Orders/queryDeliveryByPage')}"   style="background: url('__PUBLIC__/images/order-icon3.png') no-repeat 0.7rem 1.2rem; background-size:20% 30%; padding-left:1rem;"  data-icon="" onclick="_hmt.push(['_trackEvent', 'footbar', 'click', '消息'])">已付款<i id="new_msg_alert"></i></a>
        <a href="{:U('Orders/queryCancelOrders')}" style="background: url('__PUBLIC__/images/order-icon4.png')
        no-repeat 0.7rem 1.2rem; background-size:15% 30%; padding-left:1rem;" onclick="_hmt.push(['_trackEvent', 'footbar', 'click', '我的'])">取消/退款</a>
    </div>
</div>
<script>
    $(window).load(function (){
        setTimeout(function () {
            $('.kap-bottom').show();
        },2000)
    });
</script>
<include file="Common:footer"/>
</body>
</html>