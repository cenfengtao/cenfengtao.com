<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>教师节</title>
    <link rel="stylesheet" href="__PUBLIC__/vendors/upload-image/css/page-common.css">
    <link rel="stylesheet" type="text/css" href="http://www.jq22.com/jquery/font-awesome.4.6.0.css">
    <link rel="stylesheet" href="__PUBLIC__/vendors/upload-image/css/upload.css"/>
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/css/home/poster.css"/> 
<!--     <link rel="stylesheet" type="text/css" href="__PUBLIC__/css/home/common.css"/>
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/css/home/com.css"/>
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/Home/css/pageloader.css"/>  -->
    <style>
        .chose{
            position: fixed;
            bottom: 0;
            background:#f1f1f1;
            width: 100%;
            height: 0;
            border: 1px solid white;
        }
        .chose h3{
            text-align: center;
            font-size: 16px;
            background: gray;
            color: white;
            padding: 5px 0;
            position: relative;
        }
/*        .chose>img{
            position: absolute;
            right: 0;
            top: 0;
        }*/
        .chose ul{
            display: flex;
            justify-content: space-around;
            margin: 10px 0;
        }
        .chose ul li{
            text-align: center;
            width: 33%;
            float: left;
        }
        .chose ul li span{
            font-size: 12px;
            color: gray;
        }
        .chose ul li img{
            width: 100%;
            height: 200px;
            border: 1px solid gray;
        }
        .chose>img{
            position: absolute;
            right: 0.2rem;
            height:0.6rem;
            width: 0.6rem;
            top: 0.35rem;
        }
        .footer p{
            margin-top: 10px;
            font-size: 12px;
            background: orange;
            color: white;
            border: none;
            width: 100%;
            height: 35px;
            line-height: 35px;
            border-radius: none;
            text-align: center;
        }
        .img img{
            width: 100%;
            height: auto;
        }
        .confirm{
            height: 30px;
            line-height: 30px;
            font-size: 14px;
            text-align: center;
            position: relative;
            color: white;
            background-color: orange;
        }
        .confirm span{
            display: block;
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="javascript:history.back()">
            <img src="../../../../Public/images/back.png" alt="">
        </a>
        <h3>教师节</h3>
    </header>
    <article>
        <div class="wait">
            <div>
                正在合成中，请耐心等待哦！
            </div>
        </div>
        <div class="file">
            <div>
                请先上传图片再按确定哦。
            </div>
        </div>
        <div class="introduce">
            <div>
                <h3>欢迎来到教师节海报制作主页</h3>
                <p>1.请先选择你喜欢的海报模报。</p>
                <p>2.点击编辑海报上传图片进行合成。</p>
                <p>3.长按生成的海报保存图片到手机上。</p>
                <p>4.把保存的图片分享到朋友圈上，向老师们表达浓浓的敬意,感谢老师们平日里的悉心教导。</p>
            </div>
        </div>
        <div class="img">
            <img src="" alt="">
        </div>
        <div class="chose">
            <h3>海报模板</h3>
            <img src="../../../../Public/images/close.png" alt="">
            <ul class="poster">
            </ul>       
        </div>
        <div class="copy">
            <div class="content">
                <div class="text">
                    <p>请编辑图片</p>
                    <img src="../../../../Public/images/close.png" alt="">
                </div>
                <ul id="height">
                    <li class="pic">
                        <span>图片：</span>
                        <div><img id="previewResult" alt="" /></div>
                        <a href="###" id='fileChooseButton' onclick="firstFile()">上传图片</a>
                        <input class="upload-file" type="file" id="file" accept="image/*" style="display: none" name="upload" />
                        <a href="###" id="close">移除图片</a>
                    </li>
                    <li>
                        <span>标题：</span> <input type="text" class="inputValue">
                    </li>
                    <!-- <li>
                        <span>内容：</span> <textarea name="" rows="4" class="textarea"></textarea>
                    </li> -->
                </ul>
                <div class="confirm">
                    <span>确定</span>
                </div>
            </div>
            <div class="edit">
                <!-- <button id='fileChooseButton' class="button blue rarrow file-input-mask">上传图片<input class="upload-file" type="file" id="file" accept="image/*"/ multiple></button> -->
                <img id="previewResult"/>
                <img id="needCropImg" />
                <div class="app" id="uploadPage">
                    <div class="upload-loading">
                    <span class="centerXY"><i class="fa fa-spinner fa-pulse fa-3x fa-fw"></i></span>
                    </div>
                    <div class="bar"><a class="back pull-left" id="closeCrop"><i class="fa fa-reply"></i></a><a id="getFile" class="pull-right">使用</a></div>
                    <div class="main">
                        <canvas class="upload-mask">
    
                        </canvas>
                        <div class="preview-box">
                            <img id="preview"/>
                        </div>
                        <canvas class="photo-canvas">
    
                        </canvas>
                    </div>
                </div>
            </div>
            
        </div>
    </article>
    <footer class="footer">
        <ul class="radio">
            <!-- <li><a href="###" class="need">请选择海报模板</a></li> -->
            <li><a href="###" class="change">编辑海报</a></li>
        </ul>
        <p>请选择海报模板后再点击编辑海报哦！</p>
    </footer>
</body>
<script src="../../../../Application/Home/View/Activity/js/jquery.min.js"></script>
<!--<script src="__PUBLIC__/js/home/rem.js" type="text/javascript" charset="utf-8"></script>-->
<script src="__PUBLIC__/vendors/upload-image/js/require.js" ></script>
<script src="__PUBLIC__/vendors/upload-image/js/main.js"></script>
<script src="__PUBLIC__/vendors/upload-image/js/canvas-toBlob.js"></script>
<script>

function firstFile() { 
    document.getElementById("file").click(); 
    $(".content").hide();
    $("body .img img").hide();
} 
function GetRequest() {   
   var url = location.search; //获取url中"?"符后的字串   
   var theRequest = new Object();   
   if (url.indexOf("?") != -1) {   
      var str = url.substr(1);   
      strs = str.split("&");   
      for(var i = 0; i < strs.length; i ++) {   
         theRequest[strs[i].split("=")[0]]=unescape(strs[i].split("=")[1]);   
      }   
   }   
   return theRequest;   
}   
var style_id=GetRequest().style_id;
$(function(){
    // var windowHeight=$(window).height();
    // var headerHeight=$(".header").height();
    // var changeHeight=$(".change").height();
    // var imgHeight=windowHeight-headerHeight-changeHeight;
    // $(".img img").attr("height",imgHeight)
    // console.log(style_id)
    $(".introduce").click(function(){
        $(".introduce").hide()
    })
    $(".file").click(function(){
        $(".file").hide();
        $(".copy").show();
    })
    $(".chose>img").click(function(){
       $(".chose").animate({height:'0px'},1000)
    })
    $(".text>img").click(function(){
        $(".copy").hide();
    })
    $(".need").click(function(){
        $(".chose").animate({height:'282px'},1000)
    })
    $(".change").click(function(){
        $(".copy").show()
    })
    var ulHeigtht=$("#height li").height();
    var textHeight=$(".text").height();
    var ulLength=$("#height li").length;
    var confirmHeight=$(".confirm").height();
    $(".content").css("height",(ulHeigtht*ulLength+textHeight+confirmHeight)+"px")
    $.ajax({
        url:'../Poster/qrcodeFirst',
        async: true,
        type:"post",
        dataType:"json",
        data:{
            style_id:style_id
        },
        success:function(data){
            console.log(data)
            var imgL=data.data.imageData.length;
            var short=data.data.imageData;
            for(var i=0; i<=imgL-1; i++){
                $(".poster").append(
                '<li>'+
                    '<img src="'+short[i].image+'" alt="" class="'+short[i].id+'">'+
                    '<span>'+short[i].title+'</span>'+
                '</li>'
                    )
            }
            var image=data.data.data.image;
            var image_type=JSON.parse(data.data.data.image_position);
            var imageName=image_type["1"];
            for(key in imageName){
                var addName=key;
            }
            var text_type=JSON.parse(data.data.data.text_position);
            var textName=text_type["1"];
            for(key in textName){
                var title=key;
            }
            $(".img img").attr("src",image);
            // for(var i=0; i<)
             $(".chose ul li img").click(function(){
                var imgSrc=$(this).attr("src")
                var imgClass=$(this).attr("class");
                if(imgClass==1){
                    $(".confirm span").attr("class","1");
                 }else if(imgClass==2){
                    $(".confirm span").attr("class","2");
                 }else if(imgClass==3){
                    $(".confirm span").attr("class","3");
                 }



                $(".chose").css("height","0px")
                $(".img img").attr("src",imgSrc)
                $('html,body').animate({scrollTop: '0px'}, 1000);
            })
             // console.log(style_id)
            $(".confirm span").click(function(){
                if($(this).attr("class")){
                    style_id=$(this).attr("class");
                }else{
                    style_id=GetRequest().style_id;
                }
                // console.log(style_id)
                $(".copy").hide()
                var url=$("#previewResult").attr("src")
                var inputValue=$(".inputValue").val();
                var textarea=$(".textarea").val();
                if(url){
                    $(".wait").show();
                     $.ajax({
                        url:'../Poster/qrcodeByPoster',
                        async: true,
                        type:"post",
                        dataType:"json",
                        data:{
                            id:style_id,
                            background:image,
                            image_type:addName,
                            text:inputValue,
                            text_type:title,
                            image:url
                        },//后端无需在过滤头
                        success:function(data){
                            console.log(data)
                            $(".img img").attr("src","/"+data.data);
                            $(".wait").hide();
                        }
                    })
                }else{
                    $(".file").show();
                }
                 
            })
        }
    })
    $("#close").click(function(){
        $("#previewResult").removeAttr("src")
    })
    $(".fa").click(function(){
        $(".copy").show()

    })

})

    var myCrop;
   // 防require缓存
    require.config({
        urlArgs:"bust="+new Date,
        baseUrl:"__PUBLIC__/vendors/upload-image/js",
    });
    require(["jquery",'hammer','tomPlugin',"tomLib",'hammer.fake','hammer.showtouch'],function($,hammer,plugin,T){
        // document.addEventListener("touchmove",function(e){
        //     e.preventDefault();
        // });
        //初始化图片大小300*300
        var opts={cropWidth:200,cropHeight:200},
                $file=$("#file"),
                previewStyle={x:0,y:0,scale:1,rotate:0,ratio:1},
                transform= T.prefixStyle("transform"),
                $previewResult=$("#previewResult"),
                $previewBox=$(".preview-box"),
                $rotateBtn=$("#rotateBtn"),
                $getFile=$("#getFile"),
                $preview=$("#preview"),
                $uploadPage=$("#uploadPage"),
                $mask=$(".upload-mask"),
                $loading=$(".upload-loading"),
                maskCtx=$mask[0].getContext("2d"),
                $needCropImg=$("#needCropImg");

        //这是插件调用主体
        myCrop=T.cropImage({
            bindFile:$file,//绑定Input file
//            bindFile:$needCropImg[0],//绑定一个图片
            enableRatio:true,//是否启用高清,高清得到的图片会比较大
            canvas:$(".photo-canvas")[0],  //放一个canvas对象
            cropWidth:opts.cropWidth,       //剪切大小
            cropHeight:opts.cropHeight,
            bindPreview:$preview,      //绑定一个预览的img标签
            useHammer:true,            //是否使用hammer手势，否的话将不支持缩放
            oninit:function(){

            },
            onChange:function(){
                $loading.show();
                resetUserOpts();
            },
            onLoad:function(data){
                //用户每次选择图片后执行回调
                previewStyle.ratio=data.ratio;
                $preview.attr("src",data.originSrc).css({width:data.width,height:data.height}).css(transform,'scale('+1/previewStyle.ratio+')');
                myCrop.setCropStyle(previewStyle)
                $loading.hide();
            }
        });
        function resetUserOpts(){
            $(".photo-canvas").hammer('reset');
            previewStyle={scale:1,x:0,y:0,rotate:0};
            // $previewResult.attr("src",'').hide();
            $preview.attr("src",'')
        }
        $('#fileChooseButton').on('click',function(){
            setTimeout(function(){
                resetUserOpts();
            })

        })
        $(".photo-canvas").hammer({
            gestureCb:function(o){
                //每次缩放拖拽的回调
                $.extend(previewStyle,o);
//                console.log("用户修改图片",previewStyle)
                $preview.css(transform,"translate3d("+ previewStyle.x+'px,'+ previewStyle.y+"px,0) rotate("+previewStyle.rotate+"deg) scale("+(previewStyle.scale/previewStyle.ratio)+")")
            }
        });
        //选择图片
        $rotateBtn.on("click",function(){
            previewStyle.rotate+=90;
            if(previewStyle.rotate>=360){
                previewStyle.rotate-=360;
            }
            $(".photo-canvas").hammer('setRotate',previewStyle.rotate)
            myCrop.setCropStyle(previewStyle)
            $preview.css(transform,"translate3d("+ previewStyle.x+'px,'+ previewStyle.y+"px,0) rotate("+previewStyle.rotate+"deg) scale("+(previewStyle.scale/previewStyle.ratio)+")")
        });
        //获取图片并关闭弹窗返回到表单界面
        $getFile.on("click",function(){
            $(".content").show()
            $("body .img img").show();
            var cropInfo;
            $uploadPage.hide();
            myCrop.setCropStyle(previewStyle)
            //自定义getCropFile({type:"png",background:"red",lowDpi:true})
            cropInfo=myCrop.getCropFile({});
            $previewResult.attr("src",cropInfo.src).show();
            // var url=cropInfo.src;
            //可选传base64或者file对象
            //cropInfo.src cropInfo.dfd

            //you can upload img base64  :cheers:)
            // $.ajax({
            //     url:'../Test/testUpload',
            //     async: true,
            //     type:"post",
            //     dataType:"json",
            //     data:{base64:cropInfo.src.substr(22),uploadType:'base64'},//后端无需在过滤头
            //     success:function(data){
            //         if(data.result==1){
            //             console.log(data.imgPath)
            //         }
            //     }
            // })
            //you can upload new img file :cheers:)
            // cropInfo.dfd.done(function(blob){
            //     if(blob){
            //         var formData=new FormData;
            //         blob.name='imgFile'
            //         formData.append("imgFile",blob)
            //         formData.append("uploadType",'imgFile');
            //         $.ajax({
            //             url:'http://127.0.0.1/testAdjustImg/upload.php',
            //             type:"post",
            //             data:formData,
            //             processData:false,
            //             contentType: false,
            //             dataType:"json",
            //             success:function(data){
            //                 console.log(data)
            //                 if(data.result==1){
            //                     console.log(data.imgPath)
            //                 }
            //             }
            //         })
            //     }
            // })

        })
        //上传文件按钮&&关闭弹窗按钮
        $(document).delegate("#file","click",function(){
            $uploadPage.show();
        }).delegate("#closeCrop","click",function(){
            $uploadPage.hide();
            $(".content").show()
            $("body .img img").show();
            resetUserOpts();
            myCrop.setCropStyle(previewStyle)
        })
        $file.one("click",showCropModal)
        $previewResult.on('click',showCropModal)

        function showCropModal(){
            setTimeout(function(){
                $uploadPage.show();
                $mask.prop({width:$mask.width(),height:$mask.height()})
                maskCtx.fillStyle="rgba(0,0,0,0.7)";
                maskCtx.fillRect(0,0,$mask.width(),$mask.height());
                maskCtx.strokeStyle='white';
                maskCtx.lineWidth='2'
                maskCtx.clearRect(($mask.width()-opts.cropWidth)/2,($mask.height()-opts.cropHeight)/2,opts.cropWidth,opts.cropHeight)
                maskCtx.strokeRect(($mask.width()-opts.cropWidth)/2-1,($mask.height()-opts.cropHeight)/2-1,opts.cropWidth+2,opts.cropHeight+2);//Add a subpath with four points
            })
        }
        //单独绑定图片时用到
//        $needCropImg[0].addEventListener("load",showCropModal)
//        $needCropImg[0].src='./img/9-1.jpg';
    })
</script>
</html>