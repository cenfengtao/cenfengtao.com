<?php
namespace Home\Controller;

use Think\Controller;
use Think\Exception;

class MapController extends BaseController
{
    public function index()
    {
        $this->title = ("优培大地图");
        $orgAddress = M('Organization')->select();
        foreach ($orgAddress as $k => $v) {
            $file[$k] = file_get_contents("http://api.map.baidu.com/geocoder/v2/?output=json&ak=ZL7uRt3632Y1iZWucCRIc76y3LWF6U7z&address=" . $v['city'] . $v['area'] . $v['address']);
            $res[$k] = str_replace(array("\"", "{", "}"), "", $file[$k]);
            $arr[$k] = explode(":", $res[$k]);
            $x[$k] = explode(",", $arr[$k][4]);
            $y[$k] = explode(",", $arr[$k][5]);
            $data[$k] = $x[$k][0] . ':' . $y[$k][0] . ':' . $v['org_name'] . ':' . $v['city'] . $v['area'] . $v['address'] . ':' . $v['tel'] . ',';
        }
        $this->assign('data', $data);
        $this->display();
    }

    public function GPS()
    {
        $this->title = ("优培大地图");
        $token = '';
        if ($_GET['pro_id']) {
            $token = M('Product')->where("id={$_GET['pro_id']}")->getField('token');
        }
        if ($_GET['par_id']) {
            $token = M('parenting')->where("id={$_GET['par_id']}")->getField('token');
        }
        if (!$_GET['address']) {
            return show(0, '地址不能为空');
        }
        $site = M('Organization')->where(array('token' => $token))->find();
        $file = file_get_contents("http://api.map.baidu.com/geocoder/v2/?output=json&ak=ZL7uRt3632Y1iZWucCRIc76y3LWF6U7z&address=" . $_GET['address']);
        $res = str_replace(array("\"", "{", "}"), "", $file);
        $arr = explode(":", $res);
        $x = explode(",", $arr[4]);
        $y = explode(",", $arr[5]);
        $data = $x[0] . ':' . $y[0] . ':' . $site['org_name'] . ':' .$_GET['address'] . ':' . $site['tel'] . ',';
        $this->assign('data', $data);
        $this->display();
    }

    public function search()
    {
        $this->title = ("优培大地图");
        if (!$_GET['title'] || empty($_GET['title'])) {
            return show(0, '标题不能为空');
        }
        $where['org_name'] = array('LIKE', '%' . $_GET['title'] . '%');
        $add = D('Organization')->getOrgByTitle($where);
        if (!$add || empty($add)) {
            $data = 0;
        } else {
            foreach ($add as $k => $v) {
                $file[$k] = file_get_contents("http://api.map.baidu.com/geocoder/v2/?output=json&ak=ZL7uRt3632Y1iZWucCRIc76y3LWF6U7z&address=" . $v['city'] . $v['area'] . $v['address']);
                $res[$k] = str_replace(array("\"", "{", "}"), "", $file[$k]);
                $arr[$k] = explode(":", $res[$k]);
                $x[$k] = explode(",", $arr[$k][4]);
                $y[$k] = explode(",", $arr[$k][5]);
                $data[$k] = $x[$k][0] . ':' . $y[$k][0] . ':' . $v['org_name'] . ':' . $v['city'] . $v['area'] . $v['address'] . ':' . $v['tel'] . ',';
            }
        }
        $this->assign('data', $data);
        $this->display();
    }

    //微信转换百度坐标
    public function tranPosition()
    {
        header('Content-type:text/json');
        $data = file_get_contents('php://input');
        $newData = json_decode($data, true);
        $latitude = $newData["latitude"];
        $longitude = $newData["longitude"];
        //百度地图坐标转换官网：http://lbsyun.baidu.com/index.php?title=webapi/guide/changeposition
        $q = "http://api.map.baidu.com/geoconv/v1/?coords=" . $longitude . "," . $latitude . "&from=1&to=5&ak=ZL7uRt3632Y1iZWucCRIc76y3LWF6U7z";
        $resultQ = json_decode(file_get_contents($q), true);
        $latitudeNew = $resultQ["result"][0]["y"];
        $longitudeNew = $resultQ["result"][0]["x"];

        $returnDataArray = array("latitudeNew" => $latitudeNew, "longitudeNew" => $longitudeNew);
        $returnData = json_encode($returnDataArray);

        echo $returnData; //只有输出才能回传到$.ajax中的success，这样ajax中的success:function(data)中的data就收到数据了
    }
}


?>