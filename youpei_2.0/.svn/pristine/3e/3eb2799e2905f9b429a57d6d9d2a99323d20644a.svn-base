<?php
namespace Home\Controller;

use Think\Controller;
use Think\Exception;

class MapController extends BaseController
{
    public function index()
    {
        $this->title = ("优培大地图");
        $orgAddress = M('Organization')->select();
        foreach ($orgAddress as $k => $v){
            $file[$k] = file_get_contents("http://api.map.baidu.com/geocoder/v2/?output=json&ak=ZL7uRt3632Y1iZWucCRIc76y3LWF6U7z&address=".$v['city'].$v['area'].$v['address']);
            $res[$k] = str_replace(array("\"","{","}"),"",$file[$k]);
            $arr[$k] = explode(":",$res[$k]);
            $x[$k] = explode(",",$arr[$k][4]);
            $y[$k] = explode(",",$arr[$k][5]);
            $data[$k] = $x[$k][0].':'.$y[$k][0].':'.$v['org_name'].':'.$v['city'].$v['area'].$v['address'].':'.$v['tel'].',';
        }
        $this->assign('data',$data);
        $this->display();
    }

    public function GPS()
    {
        $this->title = ("优培大地图");
        if(!$_GET['id'] || empty($_GET['id'])){
            return show(0,'ID参数错误');
        }
        $token = M('Product')->where("id={$_GET['id']}")->getField('token');
        $site = M('Organization')->where(array('token'=>$token))->find();
        $file = file_get_contents("http://api.map.baidu.com/geocoder/v2/?output=json&ak=ZL7uRt3632Y1iZWucCRIc76y3LWF6U7z&address=".$site['city'].$site['area'].$site['address']);
        $res = str_replace(array("\"","{","}"),"",$file);
        $arr = explode(":",$res);
        $x = explode(",",$arr[4]);
        $y = explode(",",$arr[5]);
        $data = $x[0].':'.$y[0].':'.$site['org_name'].':'.$site['city'].$site['area'].$site['address'].':'.$site['tel'].',';
        $this->assign('data',$data);
        $this->display();
    }

    public function search()
    {
        $this->title = ("优培大地图");
        if(!$_GET['title'] || empty($_GET['title'])){
            return show(0,'标题不能为空');
        }
        $where['org_name'] = array('LIKE','%'.$_GET['title'].'%');
        $add = D('Organization')->getOrgByTitle($where);
        if(!$add || empty($add)){
            $data = 0;
        }else{
            foreach ($add as $k => $v){
                $file[$k] = file_get_contents("http://api.map.baidu.com/geocoder/v2/?output=json&ak=ZL7uRt3632Y1iZWucCRIc76y3LWF6U7z&address=".$v['city'].$v['area'].$v['address']);
                $res[$k] = str_replace(array("\"","{","}"),"",$file[$k]);
                $arr[$k] = explode(":",$res[$k]);
                $x[$k] = explode(",",$arr[$k][4]);
                $y[$k] = explode(",",$arr[$k][5]);
                $data[$k] = $x[$k][0].':'.$y[$k][0].':'.$v['org_name'].':'.$v['city'].$v['area'].$v['address'].':'.$v['tel'].',';
            }
        }
        $this->assign('data',$data);
        $this->display();
    }


}


?>