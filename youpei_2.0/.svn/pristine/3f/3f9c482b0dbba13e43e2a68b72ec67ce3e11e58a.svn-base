<include file="Common:header"/>
<style>
    .ty-view-all .ty-page{
        padding: 2.5rem 0 30.25rem 0;
    }
</style>
<div id="form_order_person" title="填写资料" class="kap-page kap-page-current">
    <div class="kap-top ty-menu-top">
        <div id="tools_msg" class="ty-tools ty-tools-inner ty-tools-current">
            <span class="title">{$title}<span class="num"></span></span>
            <a href="javascript:void(0);" onclick="history.go(-1);" class="btn left btn-user" title="返回"
               data-icon="ɒ"></a>
            <a href="{:U('Index/index',array('current'=>'1'))}" class="btn right btn-user" title="返回首页"
               data-icon="Ņ"></a>
        </div>
    </div>
    <div class="ty-page">
        <div class="ty-order-person">
            <div class="project-desc">
                <div class="project"><span class="title">{$product['title']} {$normal}</span>
                    <span class="qty">{$count}</span></div>
                <div style="padding-bottom: .5rem;margin-bottom: .5rem;border-bottom: 1px dashed #ddd;text-align: right;" name="order_contact_name">
                    <span>总价:{$totalPrice}元</span></div>
                <notempty name="coupons">
                    <div style="padding-bottom: .5rem;margin-bottom: .5rem;">
                        <p>可使用优惠券: <span style="float: right;" onclick="cancelCoupon()">取消</span></p>
                        <ul>
                            <foreach name="coupons" item="val">
                                <label for="{$val['id']}">
                                    <input type="radio" id="{$val['id']}" value="{$val['id']}" name="coupon"
                                           style="width:1rem;height:1rem;">
                                    {$val['title']}
                                </label>
                            </foreach>
                        </ul>
                    </div>
                </notempty>
                <notempty name="cashCoupons">
                    <div style="padding-bottom: .5rem;margin-bottom: .5rem;">
                        <p>可使用代金券: <span style="float: right;" onclick="cancelCashCoupon()">取消</span></p>
                        <ul>
                            <foreach name="cashCoupons" item="val">
                                <label for="{$val['id']}">
                                    <input type="checkbox" id="{$val['id']}" value="{$val['id']}" name="cashCoupon"
                                           style="width:1rem;height:1rem;">
                                    {$val['title']} &nbsp;&nbsp;
                                </label>
                            </foreach>
                        </ul>
                    </div>
                </notempty>
            </div><a id="xm"> </a>
            <div class="ty-form ty-form-contact">
                <h3 class="title">联系人信息</h3>
                <input type="hidden" name="pro_id" value="{$product['id']}">
                <input type="hidden" name="amount" value="{$count}">
                <p>
                    <label class="label">姓&#12288;名</label>
                    <span class="input"><input id="order_contact_name" class="xm" placeholder="姓名" type="text"></span>
                </p>
                <p>
                    <label class="label">电&#12288;话</label>
                    <span class="input"><input id="order_contact_mobile" class="xm" placeholder="电话" type=""></span>
                </p>
                <if condition="$product['is_mail'] eq 2">
                    <p>
                        <label class="label">地&#12288;址</label>
                        <span class="input"><input id="order_contact_address" placeholder="XX省XX市" type=""></span>
                    </p>
                </if>
                <div class="ty-order-message">
                    <textarea id="order_contact_memo" class="input-textarea" placeholder="客户留言" data-default-msg=""
                              name="memo" data-ty-required="0" data-ty-required-tips=""></textarea>
                </div>
            </div>
        </div>
        <div data-icon="" class="ty-hr"></div>
        <div class="ty-form-desc">
            <div class="text">
                <p>以上资料仅用于客服联系，信息保密！</p>
            </div>
        </div>
    </div>
    <div class="kap-bottom ty-menu-bottom">
        <div id="tools_detail_order" class="ty-tools ty-tools-order ty-tools-current">
            <a href="javascript:void(0);" class="btn-order" data-icon="ĩ" id="addOrder">提交订单</a>
        </div>
    </div>
</div>
<include file="Common:footer"/>
<script>
    $('#addOrder').click(function () {
        var pro_id = $("input[name='pro_id']").val();
        var amount = $("input[name='amount']").val();
        var coupon_id = $("input[name='coupon']:checked").val();
        var key = getQueryString('key');
        var cash_coupon_ids =[];
        $('input[name="cashCoupon"]:checked').each(function(){
            cash_coupon_ids.push($(this).val());
        });
        if(!coupon){
            var coupon = 0;
        }
        if ($('#order_contact_name').val() == '') {
            alert('填写联系人姓名');
            return;
        }
        if ($('#order_contact_mobile').val() == '') {
            alert('填写联系人电话');
            return;
        }
        if ($('#order_contact_mobile').length > 0) {
            var tel = $("#order_contact_mobile").val();
            if (!/^1(3|4|5|7|8){1}\d{9}$/.test(tel)) {
                alert("手机号码格式不正确，请重新填写");
                return;
            }
        }
        var url = "{:U('Orders/addOrder')}";
        var data = {
            pro_id: pro_id, amount: amount,
            name: $('#order_contact_name').val(),
            mobile: $('#order_contact_mobile').val(),
            message: $('#order_contact_memo').val(),
            address: $('#order_contact_address').val(),
            coupon_id:coupon_id,
            cash_coupon_ids:cash_coupon_ids,
            key:key
        };
        $.post(url, data, function (result) {
            if (result.status == 0) {
                return alert(result.msg);
            } else {
                window.location.href = "{:U('WxPay/jsapiIndex')}?orderId=" + result.orderId;
            }
        }, 'json');
    });

    function cancelCashCoupon() {
        $('input:checkbox[name="cashCoupon"]').attr('checked', false);
    }

    function cancelCoupon() {
        $('input:radio[name="coupon"]').attr('checked', false);
    }

    $(".xm").click(function() {
        $("html, body").animate({
            scrollTop: $("#xm").offset().top }, {duration: 500,easing: "swing"});
        return false;
    });

    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]);
        return null;
    }
</script>
</body>
</html>