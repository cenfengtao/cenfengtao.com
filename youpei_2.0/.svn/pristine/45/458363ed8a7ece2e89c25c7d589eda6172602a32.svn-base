<include file="Common:header"/>
<script type="text/javascript" src="__PUBLIC__/Home/js/jweixin-1.0.0.js"></script>
<script type="text/javascript" src="__PUBLIC__/Home/js/jquery.ba-hashchange.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/Home/js/jquery.exif.min.js"></script>
<script type="text/javascript" src="__PUBLIC__/Home/js/selectivizr.js"></script>
<link rel="stylesheet" href="__PUBLIC__/Home/css/message.css">
<link rel="stylesheet" href="__PUBLIC__/Home/css/comment.css">
<style>
    .isCollect:before {
        color: #f56b85;
    }

    .isCollect {
        display: inline-block;
        width: 25%;
        margin-left: 5%;
        position: relative;
        color: #f56b85;
    }

    .follow {
        display: inline-block;
        width: 25%;
        margin-left: 5%;
        position: relative;
    }
    #comments{
        background: red;
        color: white;
    }
    .ty-page{
        margin-top: 2.5rem!important;
    }
</style>
<div id="detail_activity" class="kap-page kap-page-current">
    <div class="kap-top ty-menu-top">
        <div id="tools_msg" class="ty-tools ty-tools-inner ty-tools-current">
            <span class="title">{$product['title']}<span class="num"></span></span>
            <a href="javascript:void(0);" onclick="history.go(-1);" class="btn left btn-user" title="返回"
               data-icon="ɒ"></a>
            <a href="{:U('Index/index')}" class="btn right btn-user" title="返回首页" data-icon="Ņ"></a>
        </div>
    </div>
    <div class="ty-page">
        <div class="ty-detail-cover">
            <span class="thumb"
                  style="background-image:url({$product['pic_url']}); background-size:cover"></span>
                <span class="desc-top">
                    <span data-icon="Ć" class="loc">{$organization['city']}{$organization['area']}{$organization['address']}</span>
                </span>
            <div class="desc row">
                <!--   <h3 class="title"><span id="detail_activity_title">独家重磅！7天6晚厦门研学夏令营（共四期），6.18前报名低至¥4088/人！</span></h3> -->
                <!-- 注下：如果有多个出发日期，则先进入#detail_calendar，如果仅有一个出发日期，则点后直接跳到订单页#detail_order -->

                <!--                      <div class="count">
                 <span class="icon-sale">618促销</span>
                 <span class="price">4588</span>
                 <span class="price-off">4088</span>
                 </div> -->
                <span class="bargain" data-icon="">我要砍价</span>
                <span class="status">现价: {$product['price']}元</span>
                <div class="tags">
                    <foreach name="tags" key="k" item="val">
                        <if condition="$k eq 0">
                            <span class="tag red">{$val}</span>
                            <elseif condition="$k eq 1"/>
                            <span class="tag green">{$val}</span>
                            <else/>
                            <span class="tag blue">{$val}</span>
                        </if>
                    </foreach>

                    <label class="size red">原价：{$product['original_price']}元</label>
                </div>
            </div>
            <div class="introduce">
                <span><nobr>{$product['f_title']}</nobr></span>
            </div>
            <!--    <span class="share-invite">邀请好友</span> -->
            <div class="border item curriculum" data-icon="ř" onclick="getClassTable({$product['id']})">
                <label>课程表</label>
                <span class="tip" data-icon-after="Ĩ"></span>
            </div>
            <div class="border item company" data-icon="ƃ" onclick="organ({$organization['id']})">
                <label>教学单位</label>
                <span class="tip" data-icon-after="Ĩ"></span>
            </div>
            <a href="{:U('Shop/toShopHome')}">
                <div class="mechanism">
                    <img src="{$organization['picture']}">
                    <span>{$organization['org_name']}</span>
                    <div class="score" id="descs" style="line-height: 1.3rem;">
                        <span>机构评级</span>
                 <span class="star" data-ty-talent-star="5">
                    <i class="on iconfont">Ŧ</i>
                    <i class="on iconfont">Ŧ</i>
                    <i class="on iconfont">Ŧ</i>
                    <i class="on iconfont">Ŧ</i>
                    <i class="on iconfont">Ŧ</i>
                    </span>
                        <span>环境评级</span>
                 <span class="star" data-ty-talent-star="5">
                    <i class="on iconfont">Ŧ</i>
                    <i class="on iconfont">Ŧ</i>
                    <i class="on iconfont">Ŧ</i>
                    <i class="on iconfont">Ŧ</i>
                    <i class="on iconfont">Ŧ</i>
                    </span>
                        <span>教学质量</span>
                 <span class="star" data-ty-talent-star="5">
                    <i class="on iconfont">Ŧ</i>
                    <i class="on iconfont">Ŧ</i>
                    <i class="on iconfont">Ŧ</i>
                    <i class="on iconfont">Ŧ</i>
                    <i class="on iconfont">Ŧ</i>
                    </span>
                    </div>
                </div>
            </a>
        </div>
        <div class="act-tag fixed">
            <a href="javascript:;" id="desc" class="tag detail on">详情</a>
            <a href="javascript:;" id="costc" class="tag price">费用说明</a>
            <a href="javascript:;" id="comment" class="tag qa">咨询&amp;评价</a>
        </div>
        <div class="ty-detail-content">
            <div class="article-title" id="kcxq">
                <if condition="$product['type'] eq 1">
                    <span class="title">课程详情</span>
                    <else/>
                    <span class="title">商品详情</span>
                </if>

                <img src="__PUBLIC__/images/xianqin.png" height="72" class="kcxq">
            </div>
            <div class="article top">
                <div class="text">{$product['desc']}
                    <div id="costs" style="height: 95px;"></div>
                </div>
            </div>
            <div class="article-title"><span data-icon="Ĺ" class="title">费用说明</span><img
                    src="__PUBLIC__/images/xianqin.png" height="72" class="kcxq"></div>
            <div class="article">
                <div class="text">{$product['cost']}</div>
            </div>

            <div class="fav-list">
                <volist id="val" name="headImg" offset="0" length="12">
                    <span class="avatar">
                       <img src="{$val['headImg']}">
                    </span>
                </volist>
                <span class="sum">本次活动共有{$userCount}人已下单</span>
            </div>
            <a data-icon="Ė" id="comments" class="btn-continue"
               href="{:U('Product/checkOrderInfo',array('pro_id' => $product['id']))}">赶紧下单</a>
            <!--<a class="btn-share" href="javascript:void(0);">邀请好友一起玩</a>-->
            <div class="article-title article-title2"><span data-icon="ŕ" class="title">咨询&amp;评价</span><img
                    src="__PUBLIC__/images/xianqin.png" height="72" class="kcxq"></div>
            <div class="article">
                <notempty name="isCollect">
                    <a class="isCollect" data-icon="ą"
                       href="javascript:collect({$product.id},{$product['type'] == 1?2:3})">收藏</a>
                    <else/>
                    <a class="follow" data-icon="ą"
                       href="javascript:collect({$product.id},{$product['type'] == 1?2:3})">收藏</a>
                </notempty>
                <button type="button" class="btn-comment" data-icon="Ę">说点什么..</button>
                <ul class="list-comment">
                    <volist id="val" name="productComment" offset="0" length="15" key="k">
                        <li class="item">
                            <div class="user-comment" onclick="getFather({$val['id']})">
                                <img src="{$val['headImg']}" alt="">
                                <span class="text">{$val['content']}</span>
                            </div>
                            <div class="replys">
                                <volist id="va" name="val['child']">
                                    <div class="reply" onclick='getFatherId("{$va[' id
                                    ']}","{$val['id']}")'>

                                    <div class="image"><img src="{$va['headImg']}" alt="">回复：<img
                                            src="{$va['headImgs']}" alt=""></div>

                                    <span class="text">{$va['content']}</span>
                            </div>
                    </volist>
            </div>
            </li>
            </volist>
            </ul>
        </div>
        <!-- 20160218 upadte -->
        <!-- 20160218 upadte end-->
        <span class="ty-reload" onclick="window.location.reload();" data-icon="ɇ">刷新本页面</span>
    </div>
</div>

</div>
<div class="kap-bottom ty-menu-bottom">
    <div id="tools_detail_activity" class="ty-tools ty-tools-order ty-tools-current">
        <div class="ty-tools-detail-btns">
            <a href="https://youpei.qiyukf.com/client?k=f5f0062b7b20b199e7ee5deeeb7a6fd3&wp=1&sid=113910&robotShuntSwitch=0"
               data-icon="Ē" class="btn btn-detail consult">咨询</a>
            <a href="tel:{$organization['tel']}" data-icon="Ł" class="btn-detail phone">电话</a>
            <a href="javascript:void(0);" data-ty-target="#page_talent" data-ty-talentid="" data-icon="ń"
               class="btn-detail shop">推荐</a>
            <a href="{:U('Product/checkOrderInfo',array('pro_id' => $product['id']))}" class="btn-order">
                {$product['type'] == 1?'我要报班':'我要下单'}
            </a>
            <!--<span data-icon="&#x111;" class="btn-detail-navi"></span>-->
        </div>
    </div>
</div>

<div data-kap="kap-bottomwin" class="kap-bottomwin" style="display:none;">
    <div class="kap-hitarea"></div>
    <div class="kap-win"
         style="transform: translateY(0px); transition: -webkit-transform 0.2s cubic-bezier(0, 0, 0.25, 1);">
        <div class="kap-content">
            <div class="ty-popbottom">
                <div class="title">
                    发表评论
                    <span class="ask-kf">
                        <span><span class="btn-close" data-icon="ă"></span></span>
                    </span>
                </div>
                <div class="content" style="height: 5.625rem;">
                    <div class="ty-comment-pop">
                        <input type="hidden" name="product_id" value="{$product['id']}">
                        <textarea class="input-textarea btn-comment" id="product_contact_memo"
                                  placeholder="说点什么.."></textarea>
                    </div>
                </div>
                <div class="btn-submit" id="addProduct">确定</div>
            </div>
        </div>
    </div>
</div>
<div data-kap="_kap_mask" class="kap-mask kap-mask-on" style="display:none;"></div>

<div class="kap-comment" style="display:none;">
    <div class="kap-hitarea"></div>
    <div class="kap-win"
         style="transform: translateY(0px); transition: -webkit-transform 0.2s cubic-bezier(0, 0, 0.25, 1);">
        <div class="kap-content">
            <div class="ty-popbottom">
                <div class="title">
                    发表评论
                    <span class="ask-kf">
                        <span><span class="btn-close" data-icon="ă"></span></span>
                    </span>
                </div>
                <div class="content" style="height: 5.625rem;">
                    <div class="ty-comment-pop">
                        <textarea class="input-textarea " id="product_contact_meto"
                                  placeholder="说点什么.."></textarea>
                    </div>
                </div>
                <div class="btn-submit" id="addComment" attr_father_id="" attr_type_id="">确定</div>
            </div>
        </div>
    </div>
</div>
<div data-kap="_kap_mask" class="kap-mask  kap-background" style="display:none;"></div>
<!--<input type="hidden" name="product_id" value="{$product['id']}">-->
<!--<textarea name="" id="product_contact_memo" class="btn-comment" placeholder="说点什么.."></textarea>-->
<!--<a href="javascript:void(0)" class="comment" id="addProduct">发表评论</a>-->
<script src="https://qiyukf.com/script/044865c94981c048609d5c94c1ae9c6d.js" charset="UTF-8"></script>
<script>
    $(".act-tag span").on('touchstart mousedown', function (e) {
        e.preventDefault()
//      $(".act-tag span").removeClass('on')
//      $(this).addClass('on')
//      $(".ty-detail-content .tabcon").eq($(this).index()).addClass("curr").siblings().removeClass("curr");
    })
    $(".act-tag span").click(function (e) {
        e.preventDefault();

    })

    $(function () {
        $('.act-tag span').on('touchstart mousedown', function () {
            $('html,body').animate({scrollTop: $('.act-tag').offset().top - 60}, 500);
        });
		$(".act-tag").removeClass("fixed");
    })


    $(window).scroll(function () {
        var bar_h = $(".act-tag").height();
        var _top = $(window).scrollTop();
        var tag_top = $("#detail_activity .ty-detail-cover").offset().top + $("#detail_activity .ty-detail-cover").height();
        if (tag_top - _top < bar_h) {
            $(".act-tag").addClass("fixed");
            if ($(".kap-top").hasClass("ty-menu-top-hide")) {
                $(".act-tag").addClass("top");
            } else {
                $(".act-tag").removeClass("top");
            }
        } else {
            $(".act-tag").removeClass("fixed");
        }

    });
    $('#addProduct').click(function () {
        if ($('#product_contact_memo').val() == '') {
            alert('请填写订单评价');
            return;
        }
        if ($('#product_contact_memo').val().length <= 6) {
            alert('请填写不少于6个字');
            return;
        }

        var product_id = $("input[name='product_id']").val();
        var data = {
            product_id: product_id,
            content: $('#product_contact_memo').val()
        };
        $.ajax({
            type: 'post',
            url: "{:U('Product/productDetails')}",
            data: data,
            dataType: 'json',
            success: function (res) {
                if (res.status == 0) {
                    $("#product_contact_memo").val('');
                    return alert(res.msg);
                } else if (res.status == 1) {
                    alert(res.msg);
                    $('.kap-bottomwin').css('display', 'none');
                    $('.kap-mask-on').css('display', 'none');
                    $("#product_contact_memo").val('');
                    $('.list-comment').prepend(
                            "<li class='item assign'>" +
                            "<div class='user-comment' onclick='getFather(" + res.data['id'] + ")'>" +
                            "<img src='" + res.data['headImg'] + "' alt=''><span class='text'>" + res.data['content'] + "</span>" +
                            "</div>" +
                            "<div class='replys'></div>" +
                            "</li>"
                    );
                }
            }
        })
    })
    $('.item').click(function () {
        $(this).addClass('assign');
        $(this).siblings('.item').removeClass('assign')
    });

    function getFather(id) {
        $('.kap-background').css('display', 'block');
        $('.kap-comment').css('display', 'block');
        $('.btn-close').click(function () {
            $('.kap-background').css('display', 'none');
            $('.kap-comment').css('display', 'none');
            $("#product_contact_meto").val('');
        });
        $('#addComment').attr('attr_father_id', id);
    }

    function getFatherId(id, type_id) {
        $('.kap-background').css('display', 'block');
        $('.kap-comment').css('display', 'block');
        $('.btn-close').click(function () {
            $('.kap-background').css('display', 'none');
            $('.kap-comment').css('display', 'none');
            $("#product_contact_meto").val('');
        });
        $('#addComment').attr('attr_father_id', id);
        $('#addComment').attr('attr_type_id', type_id);

    }

    $('#addComment').click(function () {
        if ($('#product_contact_meto').val() == '' && $('#product_contact_meto').val() > 0) {
            alert('内容不能为空');
            return;
        }
        if ($('#product_contact_meto').val().length <= 6) {
            alert('请填写不少于6个字');
            return;
        }
        if ($('#addComment').attr('attr_father_id') != '' && $('#addComment').attr('attr_type_id') == '') {
            var url = "{:U('Product/comment')}";
            var product_id = $("input[name='product_id']").val();
            var father_id = $('#addComment').attr('attr_father_id');
            var type_id = $('#addComment').attr('attr_father_id');
            var data = {
                product_id: product_id,
                father_id: father_id,
                type_id: type_id,
                content: $('#product_contact_meto').val()
            };
            $('.kap-background').css('display', 'none');
            $('.kap-comment').css('display', 'none');
            $("#product_contact_meto").val('');
            $.post(url, data, function (res) {
                if (res.status == 0) {
                    alert(res.msg);
                } else if (res.status == 1) {
                    alert(res.msg);
                    $('.assign .replys').append(
                            "<div class='reply' onclick='getFatherId(" + res.data['id'] + "," + res.data['type_id'] + ")'>" +
                            "<div class='image'><img src='" + res.data['headImg'] + "' alt=''>回复：<img src='" + res.data['headImgs'] + "' alt=''></div><span class='text'>" + res.data['content'] + "</span>" +
                            "</div>"
                    );
                }
            }, 'json');
        } else if ($('#addComment').attr('attr_father_id') != '' && $('#addComment').attr('attr_type_id') != '') {
            var url = "{:U('Product/comment')}";
            var product_id = $("input[name='product_id']").val();
            var father_id = $('#addComment').attr('attr_father_id');
            var type_id = $('#addComment').attr('attr_type_id');
            var data = {};
            data.product_id = product_id;
            data.father_id = father_id;
            data.type_id = type_id;
            data.content = $('#product_contact_meto').val();
            $('.kap-background').css('display', 'none');
            $('.kap-comment').css('display', 'none');
            $("#product_contact_meto").val('');
            $.post(url, data, function (res) {
                if (res.status == 0) {
                    alert(res.msg);
                } else if (res.status == 1) {
                    alert(res.msg);
                    $('.assign .replys').append(
                            "<div class='reply' onclick='getFatherId(" + res.data['id'] + "," + res.data['type_id'] + ")'>" +
                            "<div class='image'><img src='" + res.data['headImg'] + "' alt=''>回复：<img src='" + res.data['headImgs'] + "' alt=''></div><span class='text'>" + res.data['content'] + "</span>" +
                            "</div>"
                    );
                }
            }, 'json');
        }

    })
</script>
<!-- 设置分享信息 -->
<script type="text/javascript">
    //留言弹框
    $(function () {
        $('.btn-comment').click(function () {
            $('.kap-bottomwin').css('display', 'block');
            $('.kap-mask-on').css('display', 'block');
        });
        $('.btn-close').click(function () {
            $('.kap-bottomwin').css('display', 'none');
            $('.kap-mask-on').css('display', 'none');
        });
    });
    //页内跳转
    $(document).ready(function () {
        $("#desc").click(function () {
            $('html, body').animate({
                scrollTop: $("#descs").offset().top
            }, 1000);
        });
        $("#costc").click(function () {
            $('html, body').animate({
                scrollTop: $("#costs").offset().top
            }, 1000);
        });
        $("#comment").click(function () {
            $('html, body').animate({
                scrollTop: $("#comments").offset().top
            }, 500);
        });
    });

    //收藏
    function collect(id, type) {
        $.ajax({
            url: "{:U('collect')}?id=" + id + "&type=" + type,
            dataType: 'json',
            success: function (res) {
                if (res.status == 1) {
                    $('.follow').removeClass().addClass('isCollect');
                } else if (res.status == 2) {
                    $('.isCollect').removeClass().addClass('follow');
                }
            }
        })
    }

    //    机构
    function organ(id) {
        window.location.href = "{:U('Organization/home')}?id=" + id;
    }

    //课程表
    function getClassTable(id) {
        window.location.href = "{:U('Product/getClassTable')}?pro_id=" + id;
    }
</script>
<include file="Common:footer"/>
<script>
    wx.config({
        debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
        appId: "{$signPackage['appId']}", // 必填，公众号的唯一标识
        timestamp: "{$signPackage['timestamp']}", // 必填，生成签名的时间戳
        nonceStr: "{$signPackage['nonceStr']}", // 必填，生成签名的随机串
        signature: "{$signPackage['signature']}",// 必填，签名，见附录1
        jsApiList: ['onMenuShareTimeline', 'onMenuShareAppMessage', 'onMenuShareQQ', 'onMenuShareWeibo', 'hideOptionMenu', 'showOptionMenu', 'hideMenuItems', 'showMenuItems', 'hideAllNonBaseMenuItem', 'showAllNonBaseMenuItem', 'closeWindow', 'chooseImage', 'uploadImage', 'getLocation'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
    });
    wx.ready(function () {
        wx.onMenuShareAppMessage({
            title: "{$product['title']}",
            desc: "{$product['f_title']}",
            link: "{$share_url}",
            imgUrl: "{$share_img}",
            success: function () {
                share_record();
            },
            cancel: function () {
                alert('已取消');
            }
        });
        wx.onMenuShareTimeline({
            title: "{$product['title']}",
            link: "{$share_url}",
            imgUrl: "{$share_img}",
            success: function () {
                share_record();// 用户确认分享后执行的回调函数
            },
            cancel: function () {
                alert('已取消');// 用户取消分享后执行的回调函数
            }
        });
        function share_record() {
            var pro_id = "{$product['id']}";
            var url = "{:U('Product/shareRecord')}";
            $.post(url, {pro_id: pro_id}, function (result) {
                alert(result.message);
            }, 'json');
        }
    });
</script>
</body>
</html>