<?php
namespace Home\Controller;

use Think\Controller;
use Think\Exception;

class DiscoveryController extends BaseController
{
    public function demo()
    {
        $this->display();
    }

    public function ajaxIndex()
    {
        //轮播广告
        $bannerPosters = M('poster')->where(['location' => 2])->select();
        foreach ($bannerPosters as $k => $v) {
            if ($v['type'] == 1) {
                $bannerPosters[$k]['image'] = M('article')->where(['id' => $v['type_id']])->getField('image');
                $bannerPosters[$k]['url'] = "/index.php/Article/getArticle?art_id=" . $v['type_id'];
            } else if ($v['type'] == 2) {
                $bannerPosters[$k]['image'] = M('product')->where(['id' => $v['type_id']])->getField('pic_url');
                $bannerPosters[$k]['url'] = "/index.php/Product/productDetail?pro_id=" . $v['type_id'];
            } else {
                $bannerPosters[$k]['image'] = $v['image'];
                $bannerPosters[$k]['url'] = $v['type_id'];
            }
        }
        $data = [
            'bannerPosters' => $bannerPosters,
        ];
        return show(1, '获取成功', $data);
    }

    public function index()
    {
        $this->title = "发现";
        try {
            $current = (int)I('current', 2);
            $this->assign('current', $current);
            //导航分类列表
            $cateList = D('ArticleCate')->getList();
            $this->assign('cateList', $cateList);
            //精选育儿文章
            $helpChildList = D('Article')->getArticleByClass('育儿', 'id,image,title');
            $this->assign('helpChildList', $helpChildList);
            //精选福利文章
            $parentList = D('Article')->getArticleByClass('福利', 'id,image,title');
            $this->assign('parentList', $parentList);
            //热销商品
            $saleProduct = D('Product')->getSaleList(2, 6, 'id,pic_url,title,f_title,price');
            foreach ($saleProduct as $k => $v) {
                $prices = json_decode($v['price'], true);
                $price = $prices[key($prices)];
                $saleProduct[$k]['price'] = $price;
            }
            $this->assign('saleProduct', $saleProduct);
            $this->display();
        } catch (Exception $e) {
            $this->error($e->getMessage());
        }
    }

    public function loadingProduct()
    {
        $npage = (int)I("npage");
        $list = D('Product')->getListByPage($npage, 2);
        foreach ($list as $k => $v) {
            $prices = json_decode($v['price'], true);
            $price = $prices[key($prices)];
            $list[$k]['price'] = $price;
        }
        if (!$list || empty($list)) {
            $this->ajaxReturn(array('status' => 0, 'msg' => '没有数据'));
        }
        $this->ajaxReturn(array('status' => 1, 'msg' => '获取成功', 'data' => $list));
    }
}