<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Document</title>
</head>
<body>
<!-- 作品列表 -->
<ul id="contribution_list">

</ul>
<!-- 投稿 -->
<div id="upload_contribution" style="display: none;">
    <form action="/index.php/Vote/contribution" enctype="multipart/form-data" method="post">
        作品名：<input type="text" name="title"/>
        作者：<input type="text" name="username"/>
        联系电话：<input type="text" name="mobile"/>
        <input type="file" name="image"/>
        <input type="submit" value="提交">
    </form>
</div>
<script type="text/javascript" src="/Public/js/jquery-1.10.2.min.js"></script>
<script type="text/javascript">
    $(function () {
        var param = GetRequest();
        var url = "/index.php/Vote/ajaxVoteDetail";
        $.get(url, param, function (result) {
//            status 0:报错 1:投稿中 2:截止投稿 3:截止投票 4:发布结果 5:结束
            if (result.status == 0) {
                return alert(result.message);
            }
            if (result.status == 1 || result.status == 2) {
                if (result.data.type == 1) { //图片
                    $.each(result.data.contributions, function (index, value) {
                        $("#contribution_list").append(
                                "<li>" +
                                "<img src='" + value.path + "' style='width:13rem;height:17.5rem;'>" +
                                "<p style='font-size:3rem;'>" + value.title + "</p>" +
                                "<input type='number' min='1' class='vote_count_" + value.id + "'>" +
                                "<a href='javascript:toVote(" + value.id + ")' style='font-size:2rem;text-align: center;'>投票</a>" +
                                "</li>"
                        );
                    });
                }
                if (result.data.type == 2) { //视频
                    //todo
                }
            }
            if (result.status == 1) {
                $("#upload_contribution").show();
            }
        }, 'json');
    });

    //    获取url参数
    function GetRequest() {
        var url = location.search; //获取url中"?"符后的字串
        var theRequest = new Object();
        if (url.indexOf("?") != -1) {
            var str = url.substr(1);
            strs = str.split("&");
            for (var i = 0; i < strs.length; i++) {
                theRequest[strs[i].split("=")[0]] = unescape(strs[i].split("=")[1]);
            }
        }
        return theRequest;
    }

    //    投票
    function toVote(id) {
        var url = "/index.php/Vote/toVote";
        var className = ".vote_count_" + id;
        var count = $(className).val();
        $.post(url, {count: count, id: id}, function (result) {
            if (result.status == 0) {
                return alert(result.message);
            }
            if (result.status == 1) {
                return alert(result.message);
            }
        }, 'json');
    }
</script>
</body>
</html>