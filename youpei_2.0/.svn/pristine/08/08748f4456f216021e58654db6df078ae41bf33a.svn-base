<?php
namespace Home\Controller;

use Think\Controller;
use Think\Exception;
use \Think\Image;

require_once __DIR__ . '/../../../ThinkPHP/Library/Org/Util/JSDDK.class.php';

class TestController extends Controller
{
    function setSessionTest()
    {
        $_SESSION['openid'] = $_GET['open_id'];
        $_SESSION['token'] = $_GET['token'];
        echo 'setSession and token ok';
    }

    function sendTest()
    {
        $wxuser = get_wxuser($_SESSION['token']);
        $jssdk = new \JSSDK($wxuser['appid'], $wxuser['appsecret']);
        $signPackage = $jssdk->GetSignPackage();
        $this->assign('signPackage', $signPackage);
        $this->display();
    }

    public function testUpload()
    {
        $this->display();
    }

    public function test()
    {
        $this->display();
    }

    public function testEncode()
    {
        $baseStr = "";
        //匹配出图片的格式
        if (preg_match('/^(data:\s*image\/(\w+);base64,)/', $baseStr, $result)) {
            $type = $result[2];
            $new_file = "Upload/Poster/" . date('Ymd', time()) . "/";
            if (!file_exists($new_file)) {
                //检查是否有该文件夹，如果没有就创建，并给予最高权限
                $result = mkdir($new_file, 0777, true);
            }
            $new_file = $new_file . time() . ".{$type}";
            if (file_put_contents($new_file, base64_decode(str_replace($result[1], '', $baseStr)))) {
                echo '新文件保存成功：', $new_file;
            } else {
                echo '新文件保存失败';
            }
        }
    }

    public function get_lt_rounder_corner($radius)
    {
        $img = imagecreatetruecolor($radius, $radius);  // 创建一个正方形的图像
        $bgcolor = imagecolorallocate($img, 223, 0, 0);   // 图像的背景
        $fgcolor = imagecolorallocate($img, 0, 0, 0);
        imagefill($img, 0, 0, $bgcolor);
        // $radius,$radius：以图像的右下角开始画弧
        // $radius*2, $radius*2：已宽度、高度画弧
        // 180, 270：指定了角度的起始和结束点
        // fgcolor：指定颜色
        imagefilledarc($img, $radius, $radius, $radius * 2, $radius * 2, 180, 270, $fgcolor, IMG_ARC_PIE);
        // 将弧角图片的颜色设置为透明
        imagecolortransparent($img, $fgcolor);
        // 变换角度
        // $img = imagerotate($img, 90, 0);
        // $img = imagerotate($img, 180, 0);
        // $img = imagerotate($img, 270, 0);
        // header('Content-Type: image/png');
        // imagepng($img);
        return $img;
    }

    public function test2()
    {
        $w = 110;
        $h = 110; // original size
        $original_path = "E:/WWW/youpei_2.0/Public/images/qrcode2.png";
        $dest_path = "Upload" . "/" . uniqid() . '.png';
        $src = imagecreatefromstring(file_get_contents($original_path));
        $newpic = imagecreatetruecolor($w, $h);
        $result = imagealphablending($newpic, false);
        $transparent = imagecolorallocatealpha($newpic, 0, 0, 0, 127);
        $r = $w / 2;
        for ($x = 0; $x < $w; $x++)
            for ($y = 0; $y < $h; $y++) {
                $c = imagecolorat($src, $x, $y);
                $_x = $x - $w / 2;
                $_y = $y - $h / 2;
                if ((($_x * $_x) + ($_y * $_y)) < ($r * $r)) {
                    imagesetpixel($newpic, $x, $y, $c);
                } else {
                    imagesetpixel($newpic, $x, $y, $transparent);
                }
            }
        $result = imagesavealpha($newpic, true);
        Header("Content-type: image/png");  //      下面2句用来调试到页面上
        imagepng($newpic);
//        imagepng($newpic, $dest_path);
//        imagedestroy($newpic);
//        imagedestroy($src);
        // unlink($url);
    }
}
