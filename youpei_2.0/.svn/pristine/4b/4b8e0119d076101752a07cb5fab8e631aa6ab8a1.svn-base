<?php
namespace Home\Controller;

use Think\Controller;
use Think\Exception;

class ActivityController extends BaseController
{
    public function index()
    {
        $this->display();
    }
     public function demo()
    {

        $this->display();
    }
     public function activityChange()
    {

        $this->display();
    }
    public function indexAjax()
    {
        $list['product'] = M('Product')->where(array('status' => 1, 'is_activity' => 2, 'type' => 2, 'check_status' => 2))->order('create_time desc')->field('desc,cost', true)->select();
        $list['course'] = M('Product')->where(array('status' => 1, 'is_activity' => 2, 'type' => 1, 'check_status' => 2))->order('create_time desc')->field('desc,cost', true)->select();
        $list['article'] = M('Article')->where(array('show_liability' => 1, 'status' => 2, 'is_activity' => 2))->order('create_time desc')->field('content', true)->select();
        foreach ($list['article'] as $k => $v) {
            $list['article'][$k]['count'] = D('Comment')->getCountByArtId($v['id']);
            $list['article'][$k]['collect'] = D('Collect')->getPageByType($v['id'], 5);
        }
        foreach ($list['course'] as $k => $v) {
            if(strlen($list['course'][$k]['title']) > 28){
                $list['course'][$k]['titles'] = mb_substr($list['course'][$k]['title'],0,14,'utf-8').'...';
            }else{
                $list['course'][$k]['titles'] = $list['course'][$k]['title'];
            }
            $org[$k] = M('organization')->where(array('id' => $v['org_id']))->find();
            $list['course'][$k]['add'] = $org[$k]['city'] . $org[$k]['area'] . $org[$k]['address'];
            $tags = explode(' ', $v['tag']);
            $list['course'][$k]['tagA'] = $tags[0] ?: '';
            $list['course'][$k]['tagB'] = $tags[1] ?: '';
            $list['course'][$k]['tagC'] = $tags[2] ?: '';
        }
        $productCount = count($list['product']);
        $courseCount = count($list['course']);
        $articleCount = count($list['article']);
        $allCount = array($productCount, $courseCount, $articleCount);
        $count = array_search(max($allCount), $allCount);
        $data = [];
        for ($i = 0; $i < $allCount[$count]; $i++) {
            $data[$i]['article'] = $list['article'][$i];
            $data[$i]['product'] = $list['product'][$i];
            $data[$i]['course'] = $list['course'][$i];
            if (empty($data[$i]['article'])) {
                unset($data[$i]['article']);
            }
            if (empty($data[$i]['product'])) {
                unset($data[$i]['product']);
            }
            if (empty($data[$i]['course'])) {
                unset($data[$i]['course']);
            }
        }
        return show(1, '', $data);
    }
}


?>