<!DOCTYPE html>
<!--headTrap<body></body><head></head><html></html>-->
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
    <title>投稿</title>
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/css/home/common.css"/>
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/css/home/com.css"/>
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/Home/css/pageloader.css"/>
    <link rel="stylesheet" type="text/css" href="__PUBLIC__/css/home/userContribution.css"/>
    <script type="text/javascript">
        if(/msie/i.test(navigator.userAgent)){window.location.href="http://www.youpei-exc.com/"}
    </script>
    <!--  <script>
         var _hmt = _hmt || [];
         (function() {
           var hm = document.createElement("script");
           hm.src = "https://hm.baidu.com/hm.js?548e13b07cb36e38bfd73870368a0253";
           var s = document.getElementsByTagName("script")[0];
           s.parentNode.insertBefore(hm, s);
         })();
     </script> -->
</head>
<body class="kap-loading ty-view-all">
<include file="Common:common"/>
<header class="header">
    <a href="javascript:history.back()" class="back">
        <img src="../../../../Public/images/back.png" alt="">
    </a>
    <h3>投稿</h3>
    <a href="../Index/index.html" class="home" data-icon="Ņ"></a>
</header>
<article class="middle"> 
     <form  enctype="multipart/form-data"  method="post" onsubmit="return sub();" id="formId">
        <section class="works">
            <span>作品标题：</span>
            <input type="text" value="" name="title" id="title">
            <img src="../../../../Public/images/works.png" alt="">
        </section>
         <section class="works">
            <span>作者尊称：</span>
            <input type="text" value="" name="username" id="userName">
            <img src="../../../../Public/images/works.png" alt="">
        </section>
         <section class="works">
            <span>联系电话：</span>
            <input type="tel" value="" maxlength="11" onchange="testTel(this.value)" name="mobile" id="mobile">
            <img src="../../../../Public/images/works.png" alt="">
            <input type="text" value="" name="vote_id" id="vote_id" style="display: none;">
            <input type="text" value="" name="path" id="path" style="display: none;">
        </section>
        <section class="img">
        </section>
        <section class="upload">
            <a href="###" onclick="firstFile()">点击上传</a>
            <input type="button" value="提交" class="submit" onclick="sub()" />
            <input type="file" hidefocus="true" name="files" id="file" title="上传照片" onchange="getPhoto(this); getUrl(this.files,this.id);" style="display: none;" accept="image/* vedio/* " capture="camcorder camera"/>  
        </section>
        <section class="hidden">
        	<canvas id="myCanvas" style="display: none"></canvas>
			<img src="" alt="" id="ago" style="width: 500px; display: none;"/>
			<img src="" alt="" id="press" style="display: none;"/>
        </section>
    </form>    
    <section class="explain">
        <h3>投稿说明：</h3>
        <p>1.只可上传1幅图片或1个视频。</p>
        <p>2.上传视频建议采用微信短视频后保存上传，视频限制最大12MB。</p>
        <p>3.投稿后请到“个人中心-我的活动”处查看活动进度。</p>
    </section>
</article>
<script src="__PUBLIC__/Home/js/jquery.min.js" type="text/javascript" charset="utf-8"></script>
<script src="__PUBLIC__/Home/js/pageloader.js" type="text/javascript" charset="utf-8"></script>
<script src="__PUBLIC__/js/home/rem.js" type="text/javascript" charset="utf-8"></script>
<script type="text/javascript" src="__PUBLIC__/Home/js/jweixin-1.0.0.js"></script>
<script>
// 手机号码正则验证
var testTel=function(value){
    var reg=/^(13[0-9]|14[5|7]|15[0|1|2|3|5|6|7|8|9]|18[0|1|2|3|5|6|7|8|9])\d{8}$/;
    if(!reg.test(value)){
        alert("你输入的手机号码不正确，请重新输入。")
        return false;
    }
}  
// 判断手机类型
function fBrowserRedirect(){
 var sUserAgent = navigator.userAgent.toLowerCase();
 var isIphone = sUserAgent.match(/iphone/i) == "iphone";
 var isAndroid = sUserAgent.match(/android/i) == "android";
 if(isIphone){ $("#file").attr("accept","");
 $("#file").attr("capture","");
 }
// if(isAndroid){ window.location.href = "download/android.html"; }
}
fBrowserRedirect();
// 点击上传实现上传文件
function firstFile() { 
    document.getElementById("file").click(); 
} 

    //    获取url参数
    function getQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)", "i");
        var r = window.location.search.substr(1).match(reg);
        if (r != null) return unescape(r[2]);
        return null;
    }
    var id = getQueryString('id');

    // 微信端分享
    $.ajax({
        type: "get",
        url: "/index.php/Vote/ajaxContribution",
        aysnc: true,
        dataType: "json",
        data:{
            id:id,
        },
        success:function(data){
            // console.log(data);
            var title=data.data.share_title;
            var f_title=data.data.share_desc;
            var shareUrl=data.data.share_url;
            var shareImg=data.data.share_img;
            // 调用微信的分享接口
            setTimeout(function(){
                wx.config({
                    debug: false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来，若要查看传入的参数，可以在pc端打开，参数信息会通过log打出，仅在pc端时才会打印。
                    appId: "{$signPackage['appId']}", // 必填，公众号的唯一标识
                    timestamp: "{$signPackage['timestamp']}", // 必填，生成签名的时间戳
                    nonceStr: "{$signPackage['nonceStr']}", // 必填，生成签名的随机串
                    signature: "{$signPackage['signature']}",// 必填，签名，见附录1
                    jsApiList: ['onMenuShareTimeline', 'onMenuShareAppMessage', 'onMenuShareQQ', 'onMenuShareWeibo', 'hideOptionMenu', 'showOptionMenu', 'hideMenuItems', 'showMenuItems', 'hideAllNonBaseMenuItem', 'showAllNonBaseMenuItem', 'closeWindow', 'chooseImage', 'uploadImage', 'getLocation'] // 必填，需要使用的JS接口列表，所有JS接口列表见附录2
                });
                wx.ready(function () {
                    wx.onMenuShareAppMessage({
                        title: title,
                        desc: f_title,
                        link: shareUrl,
                        imgUrl: shareImg,
                        success: function () {
                            share_record();
                        },
                        cancel: function () {
                            alert('已取消');
                        }
                    });
                    wx.onMenuShareTimeline({
                        title: title,
                        link: shareUrl,
                        imgUrl: shareImg,
                        success: function () {
                            share_record();// 用户确认分享后执行的回调函数
                        },
                        cancel: function () {
                            alert('已取消');// 用户取消分享后执行的回调函数
                        }
                    });

                    function share_record() {
                        var data = new Array();
                        data[id] = getQueryString(id);
                        data[share_user_id] = getQueryString(share_user_id);
                     var url = "{:U('Vote/userContributionRecord')}";
                     $.post(url, data, function (result) {
                     alert(result.message);
                     }, 'json');
                     }
                });
            },1000)
        }
    });

</script>
<script type="text/javascript">  
// 判读是否未IE
function isIE(){
return (document.all && window.ActiveXObject && !window.opera) ? true : false;
}
// 限制图片类型和大小
function image(target){
     var fileSize = 0; 
       if (isIE() && !target.files) {     
         var filePath = target.value;     
         var fileSystem = new ActiveXObject("Scripting.FileSystemObject");        
         var file = fileSystem.GetFile (filePath);     
         fileSize = file.Size;    
       } else {    
        fileSize = target.files[0].size;     
        }              
        var name=target.value;
        var fileName = name.substring(name.lastIndexOf(".")+1).toLowerCase();
        if(fileName !="jpg" && fileName !="jpeg" && fileName !="pdf" && fileName !="png" && fileName !="dwg" && fileName !="gif" ){
          alert("请选择图片格式文件上传(jpg,png,gif,dwg,pdf,gif等)！");
            target.value="";
            return
        }
         var size = fileSize / 1024;    
        if(size>5000){
         alert("附件不能大于5M");
         target.value="";
         return
        }
}
// 限制视频类型和大小
function photo(target){
    var fileSize = 0;  
          if (isIE() && !target.files) {     
     var filePath = target.value;     
     var fileSystem = new ActiveXObject("Scripting.FileSystemObject");        
     var file = fileSystem.GetFile (filePath);     
     fileSize = file.Size;    
   } else {    
    fileSize = target.files[0].size;     
    }   
    var name=target.value;
    var fileName = name.substring(name.lastIndexOf(".")+1).toLowerCase();
    if(fileName !="mp4"){
      alert("请选择视频格式文件mp4进行上传");
        target.value="";
        return
    }
    var size = fileSize / 1024;    
    if(size>12000){  
     alert("附件不能大于12M");
     target.value="";
     return
    }
}
// 点击上传图片获取路径进行放入
function getPhoto(file){
    if (file.files && file.files[0]){
        var reader = new FileReader();
        reader.onload = function(evt){
            var url=evt.target.result;
//                  $(".img img").attr("src",evt.target.result)
           if(url.indexOf("data:image/")>-1){
                $(".img").html('<img src="'+evt.target.result+'">')
                $("#path").val(evt.target.result)
            }
            if(url.indexOf("data:video/")>-1){
                jQuery(".img").html('<div class="video"><video src="'+evt.target.result+'" id="video" autoplay></video></div>')
                 $("#path").val(evt.target.result)
                 $(".video").click(function(){
                    $("#video")[0].play();
                })
            }
          }
        reader.readAsDataURL(file.files[0]);
    }
    else{
            if(url.indexOf("image")>-1){
                jQuery(".img").html('<img src="'+evt.target.result+'">')
                $("#path").val(evt.target.result)
            }
            if(url.indexOf("video")>-1||url.indexOf("mp4")>-1){
                $(".img").html('<div class="video"><video src="'+evt.target.result+'" id="video"></video></div>')
                $("#path").val(evt.target.result)
                 $("#video").click(function(){
                    $("#video")[0].play();
                    $(".video img").hide();
                })
            }
    }

}
function getUrl(fil, id) {
            var Cnv = document.getElementById('myCanvas');
            var Cntx = Cnv.getContext('2d');//获取2d编辑容器
            var imgss =   new Image();
            var agoimg=document.getElementById("ago");
            for (var intI = 0; intI < fil.length; intI++) {
                var tmpFile = fil[intI];
                var reader = new FileReader();
                reader.readAsDataURL(tmpFile);
                reader.onload = function (e) {
                    url = e.target.result;
                    imgss.src = url;
                    agoimg.src=url;
                    agoimg.onload = function () {
                        //等比缩放
                        var m = imgss.width / imgss.height;
                         Cnv.height =300;//该值影响缩放后图片的大小
                         Cnv.width= 300*m ;
                        //img放入画布中
                        //设置起始坐标，结束坐标
                        Cntx.drawImage(agoimg, 0, 0,300*m,300);
                    }
                }
            }
        }
// 进入页面判断之前是否上传，有就放进去
var vote_id = getQueryString('vote_id');
$("#vote_id").val(vote_id)
$(function(){
    $.ajax({
        type: "get",
        url: "/index.php/Vote/uploadType",
        aysnc: true,
        dataType: "json",
        data:{
            vote_id:vote_id,
        },
        success:function(data){
            if(data.status==1){
                if(data.data.type==1){
                if(data.data.userUpload.upload_status==2){
                    var title=data.data.userUpload.title;
                    var userName=data.data.userUpload.username;
                    var mobile=data.data.userUpload.mobile;
                    var src=data.data.userUpload.path;
                    $("#title").val(title)
                    $("#userName").val(userName)
                    $("#mobile").val(mobile)
                    $(".img").html('<img src="'+src+'">')
                }
                    alert("亲，请上传图片。")
                    $("#file").attr("onchange","image(this); getPhoto(this)")
                    var img=$(".img img").attr("src")
                    $("#path").val(img)
                }
                if(data.data.type==2){
                    if(data.data.userUpload.upload_status==2){
                        var title=data.data.userUpload.title;
                        var userName=data.data.userUpload.username;
                        var mobile=data.data.userUpload.mobile;
                        var src=data.data.userUpload.path;
                        $("#title").val(title)
                        $("#userName").val(userName)
                        $("#mobile").val(mobile)
                        $(".img").html('<div class="video"><video src="'+src+'" id="video" autoplay></video></div>')
                    }
                    alert("亲，请上传视频。")
                    $("#file").attr("onchange","photo(this); getPhoto(this)")
                    var img=$(".img video").attr("src")
                    $("#path").val(img)
                }
            }    
        }
    })
})
// 点击提交表单数据
function sub() {  
    $.ajax({  
        cache: true,  
        type: "POST",  
        url:"/index.php/Vote/ajaxContribution",  
        data:$("#formId").serialize(),// 你的formid  
        async: false,   
        success: function(data) {
           var data=JSON.parse(data)
           alert(data.message)
        }  
    });  
}  
</script>  
</body>
</html>
<!--tailTrap<body></body><head></head><html></html>-->