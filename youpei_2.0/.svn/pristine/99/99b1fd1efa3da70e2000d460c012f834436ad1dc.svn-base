<?php
/**
 * 广告位管理
 */
namespace Admin\Controller;

use Think\Controller;
use Think\Exception;

class PosterController extends CommonController
{
    public function index()
    {
        //发现页广告
        $discoverList = M('poster')->where(['location' => 2])->order('sort asc')->select();
        foreach ($discoverList as $k => $v) {
            if ($v['type'] == 1) {
                $article = M('article')->where(['id' => $v['type_id']])->field('title,image')->find();
                $discoverList[$k]['title'] = $article['title'];
                $discoverList[$k]['image'] = $article['image'];
            } else if ($v['type'] == 2) {
                $product = M('product')->where(['id' => $v['type_id']])->field('title,pic_url')->find();
                $discoverList[$k]['title'] = $product['title'];
                $discoverList[$k]['image'] = $product['pic_url'];
            }
        }
        $this->assign('discoverList', $discoverList);
        $this->display();
    }

    public function addPoster()
    {
        if ($_POST) {
            if (!$_POST['location']) {
                return show(0, '位置参数错误');
            }
            if (!$_POST['type'] || !is_numeric($_POST['type'])) {
                return show(0, '类型不能为空');
            }
            if (($_POST['type'] == 1 && !$_POST['art_id']) || ($_POST['type'] == 2 && !$_POST['pro_id'])) {
                return show(0, '类型ID不能为空');
            }
            $insertData = [
                'location' => $_GET['location'],
                'type' => $_POST['type'],
                'type_id' => $_POST['type'] == 1 ? $_POST['art_id'] : $_POST['pro_id'],
            ];
            $id = D('Poster')->insert($insertData);
            if ($id) {
                return show(1, '添加成功');
            } else {
                return show(0, '添加失败');
            }
        } else {
            $articleList = D('Article')->getArticleByToken($this->token, 'id,title');
            $productList = M('Product')->where(array('status' => 1, 'token' => $this->token))->field('title,id')->select();
            $this->assign('articleList', $articleList)->assign('productList', $productList);
            $this->display();
        }
    }

    public function editPoster()
    {
        if ($_POST) {

        } else {
            if (!$_GET['id']) {
                $this->error('参数错误');
            }
            $poster = D('Poster')->find($_GET['id']);
            $this->assign('poster', $poster);
            $this->display();
        }
    }

    public function deletePoster()
    {

    }
}