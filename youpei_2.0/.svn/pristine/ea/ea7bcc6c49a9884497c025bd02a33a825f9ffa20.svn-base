<?php
namespace Home\Controller;

use Think\Controller;
use Think\Exception;
use \Think\Image;
use Org\Util\ExcelToArray;

require_once __DIR__ . '/../../../ThinkPHP/Library/Org/Util/JSDDK.class.php';

class TestController extends Controller
{
    function setSessionTest()
    {
        $_SESSION['openid'] = $_GET['open_id'];
        $_SESSION['token'] = $_GET['token'];
        $this->display();
    }

    public function test()
    {
        $result = $this->deldir('/app/www/youpei_2.0/Application/Runtime/Cache');
        var_dump($result);
        exit;
    }

    function deldir($dir) {
        //先删除目录下的文件：
        $dh=opendir($dir);
        while ($file=readdir($dh)) {
            if($file!="." && $file!="..") {
                $fullpath=$dir."/".$file;
                if(!is_dir($fullpath)) {
                    unlink($fullpath);
                } else {
                    $this->deldir($fullpath);
                }
            }
        }
        closedir($dh);
        //删除当前文件夹：
        if(rmdir($dir)) {
            return true;
        } else {
            return false;
        }
    }

    public function responseExcel()
    {
        $this->success('添加成功', 'Index/index');
    }

    //创建一个读取excel数据，可用于入库
    public function _readExcel($path)
    {
        //引用PHPexcel 类
        include_once(VENDOR_PATH . 'PHPExcel/Classes/PHPExcel.php');
        include_once(VENDOR_PATH . 'PHPExcel/Classes/PHPExcel/IOFactory.php');//静态类
        $type = 'Excel2007';//设置为Excel5代表支持2003或以下版本，Excel2007代表2007版
        $xlsReader = \PHPExcel_IOFactory::createReader($type);
        $xlsReader->setReadDataOnly(true);
        $xlsReader->setLoadSheetsOnly(true);
        $Sheets = $xlsReader->load($path);
        //开始读取上传到服务器中的Excel文件，返回一个二维数组
        $dataArray = $Sheets->getSheet(0)->toArray();
        return $dataArray;
    }

    function video()
    {
        $name = md5(date('YmdHis')) . ".png";
        /*$from = "E:\\UPLOAD\\cw\\20150626\\558d0d11ae285.mp4";
        $to = "E:\\UPLOAD\\cover_images\\";*/
        $from = "/Public/image/123.mp4";
        $to = "/Upload/" . date('Ymd') . "/";
        $str = "ffmpeg -i " . $from . " -y -f mjpeg -ss 3 -t 1 -s 740x500 " . $to . $name;
        exec($str);
        var_dump($name);
        var_dump($from);
        var_dump($to);
        var_dump($str);
        /*exec('ffmpeg -i /Public/image/123.mp4 -y -f image2 -ss 8 -t 0.001 -s 350x240 test.jpg',$video);
        var_dump($video);*/
    }
}
