<?php
namespace Home\Controller;

use Think\Controller;
use Think\Exception;
use \Think\Image;

require_once __DIR__ . '/../../../ThinkPHP/Library/Org/Util/JSDDK.class.php';

class TestController extends Controller
{
    function setSessionTest()
    {
        $_SESSION['openid'] = $_GET['open_id'];
        $_SESSION['token'] = $_GET['token'];
        $this->display();
    }

    public function test()
    {
        $this->display();
    }

    public function testEncode()
    {
        $baseStr = "";
        //匹配出图片的格式
        if (preg_match('/^(data:\s*image\/(\w+);base64,)/', $baseStr, $result)) {
            $type = $result[2];
            $new_file = "Upload/Poster/" . date('Ymd', time()) . "/";
            if (!file_exists($new_file)) {
                //检查是否有该文件夹，如果没有就创建，并给予最高权限
                $result = mkdir($new_file, 0777, true);
            }
            $new_file = $new_file . time() . ".{$type}";
            if (file_put_contents($new_file, base64_decode(str_replace($result[1], '', $baseStr)))) {
                echo '新文件保存成功：', $new_file;
            } else {
                echo '新文件保存失败';
            }
        }
    }

    public function attentioni()
    {
        $access_token = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=wx2a478415b419d817&secret=5777fd0e27efa96cf5c85bbf1d2e5baa";
        $access_msg = json_decode(file_get_contents($access_token));
        $token = $access_msg->access_token;
        $openid = $this->__checkOpenId();
        $subscribe_msg = "https://api.weixin.qq.com/cgi-bin/user/info?access_token=$token&openid=$openid";
        $subscribe = json_decode(file_get_contents($subscribe_msg));
        $result = $subscribe->subscribe;
        if ($result === 1) {
            echo "已关注";
        } else {
            echo "未关注";
        }
    }
    protected function __checkOpenId()
    {
        $openid = $_SESSION['openid'];
        if (!$openid) {
            echo "暂无openID";
        }
        return $openid;
    }

}
